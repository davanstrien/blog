<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel van Strien">
<meta name="dcterms.date" content="2025-01-07">
<meta name="description" content="Analysis of the FineWeb-C dataset">

<title>How Fine is FineWeb2? – Daniel van Strien</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../icons/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-c75bcb89907db7808f0349b764a1a524.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="85cb27d6-dbf9-43d7-97d0-be4e6724de7a"></script>
<meta name="msvalidate.01" content="4246174F24A3CB7C9CBEAA94E1FF8E84">
<meta name="google-site-verification" content="C7WoFOEuA4Msbvvk-kgDd_C6VGphZTp3awy_acXjZYU">


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Daniel van Strien</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/davanstrien"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/vanstriendaniel"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How Fine is FineWeb2?</h1>
  <div class="quarto-categories">
    <div class="quarto-category">polars</div>
    <div class="quarto-category">huggingface</div>
    <div class="quarto-category">fineweb</div>
  </div>
  </div>

<div>
  <div class="description">
    Analysis of the FineWeb-C dataset
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel van Strien </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 7, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Recently <a href="https://huggingface.co/datasets/HuggingFaceFW/fineweb-2">FineWeb2</a> was released, adding multilingual data to the original FineWeb dataset. As part of the <a href="https://huggingface.co/blog/davanstrien/fineweb2-community">FineWeb-C community initiative</a>, contributors have been annotating samples from this dataset to assess educational quality across different languages.</p>
<p>The goal of this effort is to reproduce something similar to the original <a href="https://huggingface.co/datasets/HuggingFaceFW/fineweb-edu">FineWeb-Edu</a> dataset for all languages. You can read more about why this is important in the <a href="https://huggingface.co/blog/davanstrien/fineweb2-community">FineWeb-C blog post</a>.</p>
<section id="analyzing-the-fineweb-c-community-annotations" class="level3">
<h3 class="anchored" data-anchor-id="analyzing-the-fineweb-c-community-annotations">Analyzing the FineWeb-C Community Annotations</h3>
<p>This post examines the annotation data collected so far through the FineWeb-C project. For most languages, community members have annotated random samples of approximately 1,000 examples from FineWeb2. The annotations focus on:</p>
<ul>
<li>Educational value assessment</li>
<li>Language identification verification</li>
<li>Problematic content flagging</li>
</ul>
<p>Let’s explore what the community annotations tell us about the quality and characteristics of content across different languages in FineWeb2.</p>
<p>We’ll start by installing the necessary libraries.</p>
<div id="cell-3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install polars seaborn matplotlib huggingface_hub </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> huggingface_hub <span class="im">import</span> list_repo_files</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># bump up the number of rows in the polars table so we can see more data</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>pl.Config.set_tbl_rows(<span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll use Polars to load the annotations but we could also load in Pandas, Dask, DuckDB, PySpark, or the Hugging Face Datasets library!</p>
<p>The fineweb-c dataset has a config per language but also a general config. We’ll load all the parquet files for each language, which we can get using the <code>list_repo_files</code> function from the <code>huggingface_hub</code> library.</p>
<div id="cell-6" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>paths <span class="op">=</span> list_repo_files(<span class="st">"data-is-better-together/fineweb-c"</span>, repo_type<span class="op">=</span><span class="st">"dataset"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>paths <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> paths <span class="cf">if</span> f.endswith(<span class="st">".parquet"</span>) <span class="kw">and</span> <span class="st">"data"</span> <span class="kw">not</span> <span class="kw">in</span> f]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>paths</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>['arb_Arab/train-00000-of-00001.parquet',
 'ary_Arab/train-00000-of-00001.parquet',
 'arz_Arab/train-00000-of-00001.parquet',
 'bar_Latn/train-00000-of-00001.parquet',
 'cmn_Hani/train-00000-of-00001.parquet',
 'dan_Latn/train-00000-of-00001.parquet',
 'fas_Arab/train-00000-of-00001.parquet',
 'fil_Latn/train-00000-of-00001.parquet',
 'fin_Latn/train-00000-of-00001.parquet',
 'fra_Latn/train-00000-of-00001.parquet',
 'gmh_Latn/train-00000-of-00001.parquet',
 'hin_Deva/train-00000-of-00001.parquet',
 'lvs_Latn/train-00000-of-00001.parquet',
 'rus_Cyrl/train-00000-of-00001.parquet',
 'slk_Latn/train-00000-of-00001.parquet',
 'tat_Cyrl/train-00000-of-00001.parquet',
 'vie_Latn/train-00000-of-00001.parquet']</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pl.scan_parquet(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    [<span class="ss">f"hf://datasets/data-is-better-together/fineweb-c/</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> p <span class="kw">in</span> paths]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-many-languages-are-included-in-the-dataset-so-far" class="level3">
<h3 class="anchored" data-anchor-id="how-many-languages-are-included-in-the-dataset-so-far">How many languages are included in the dataset so far?</h3>
<div id="cell-9" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df.select(pl.col(<span class="st">"language_code"</span>)).unique().collect().count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (1, 1)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">language_code</th>
</tr>
<tr class="even">
<th>u32</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>17</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We can also see how many rows there are per language.</p>
<div id="cell-11" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df.group_by([<span class="st">"language_code"</span>]).agg(pl.col(<span class="st">"id"</span>).<span class="bu">len</span>().alias(<span class="st">"n_rows"</span>)).sort(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_rows"</span>, descending<span class="op">=</span><span class="va">True</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (17, 2)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">language_code</th>
<th data-quarto-table-cell-role="th">n_rows</th>
</tr>
<tr class="even">
<th>str</th>
<th>u32</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"tat_Cyrl"</td>
<td>1681</td>
</tr>
<tr class="even">
<td>"fin_Latn"</td>
<td>1000</td>
</tr>
<tr class="odd">
<td>"fil_Latn"</td>
<td>1000</td>
</tr>
<tr class="even">
<td>"rus_Cyrl"</td>
<td>1000</td>
</tr>
<tr class="odd">
<td>"arb_Arab"</td>
<td>1000</td>
</tr>
<tr class="even">
<td>"arz_Arab"</td>
<td>1000</td>
</tr>
<tr class="odd">
<td>"ary_Arab"</td>
<td>1000</td>
</tr>
<tr class="even">
<td>"gmh_Latn"</td>
<td>1000</td>
</tr>
<tr class="odd">
<td>"slk_Latn"</td>
<td>1000</td>
</tr>
<tr class="even">
<td>"cmn_Hani"</td>
<td>1000</td>
</tr>
<tr class="odd">
<td>"fra_Latn"</td>
<td>1000</td>
</tr>
<tr class="even">
<td>"hin_Deva"</td>
<td>1000</td>
</tr>
<tr class="odd">
<td>"bar_Latn"</td>
<td>1000</td>
</tr>
<tr class="even">
<td>"lvs_Latn"</td>
<td>1000</td>
</tr>
<tr class="odd">
<td>"vie_Latn"</td>
<td>1000</td>
</tr>
<tr class="even">
<td>"dan_Latn"</td>
<td>1000</td>
</tr>
<tr class="odd">
<td>"fas_Arab"</td>
<td>1000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We could also directly use the datasets viewer to get this information! This can be a really useful way to explore the data very quickly without having to load it locally.</p>
<iframe src="https://huggingface.co/datasets/data-is-better-together/fineweb-c/embed/sql-console/rroUpCS" frameborder="0" width="100%" height="560px">
</iframe>
</section>
<section id="number-of-annotators" class="level2">
<h2 class="anchored" data-anchor-id="number-of-annotators">Number of annotators</h2>
<p>Since starting this project we’ve found some languages have had more problematic data, including languages where a lot of data was identified in the wrong language. Because of this for some languages we’ve set a higher or lower “retirement” threshold before retiring a sample. This means some languages have only a single annotator labeling each example whilst others have had multiple people annotate each example.</p>
<p>Let’s look at the mean number of annotators per language.</p>
<div id="cell-15" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df.group_by([<span class="st">"language_code"</span>]).agg(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"educational_value_labels"</span>).<span class="bu">list</span>.<span class="bu">len</span>().mean().alias(<span class="st">"n_annotators"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>).sort(<span class="st">"n_annotators"</span>, descending<span class="op">=</span><span class="va">True</span>).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (17, 2)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">language_code</th>
<th data-quarto-table-cell-role="th">n_annotators</th>
</tr>
<tr class="even">
<th>str</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"vie_Latn"</td>
<td>2.869</td>
</tr>
<tr class="even">
<td>"dan_Latn"</td>
<td>2.573</td>
</tr>
<tr class="odd">
<td>"ary_Arab"</td>
<td>1.019</td>
</tr>
<tr class="even">
<td>"fin_Latn"</td>
<td>1.017</td>
</tr>
<tr class="odd">
<td>"fra_Latn"</td>
<td>1.012</td>
</tr>
<tr class="even">
<td>"arz_Arab"</td>
<td>1.006</td>
</tr>
<tr class="odd">
<td>"slk_Latn"</td>
<td>1.006</td>
</tr>
<tr class="even">
<td>"tat_Cyrl"</td>
<td>1.003569</td>
</tr>
<tr class="odd">
<td>"lvs_Latn"</td>
<td>1.003</td>
</tr>
<tr class="even">
<td>"rus_Cyrl"</td>
<td>1.003</td>
</tr>
<tr class="odd">
<td>"arb_Arab"</td>
<td>1.002</td>
</tr>
<tr class="even">
<td>"fas_Arab"</td>
<td>1.001</td>
</tr>
<tr class="odd">
<td>"gmh_Latn"</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>"hin_Deva"</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>"cmn_Hani"</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>"bar_Latn"</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>"fil_Latn"</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Ideally as we progress with the project we’ll increase the overlap at least for some time to see how much annotators agree (more on this below) but we also don’t want people to spend a lot of time annotating the same sample if it’s of low quality.</p>
<section id="look-at-the-distribution-of-labels" class="level3">
<h3 class="anchored" data-anchor-id="look-at-the-distribution-of-labels">Look at the distribution of labels</h3>
<p>No we’ve got a sense of how many annotators there are per language, let’s look at the distribution of labels. Since we sometimes have multiple labels for each sample we’ll simplify things a bit to just look at the first label for each sample. For some languages this will be the only label anyway. If we work with a specific language for a longer time we’ll also want to consider the agreement between annotators.</p>
<div id="cell-18" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.with_columns(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"educational_value_labels"</span>).<span class="bu">list</span>.first().alias(<span class="st">"label"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>).collect()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (1, 9)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">educational_value_labels</th>
<th data-quarto-table-cell-role="th">annotator_ids</th>
<th data-quarto-table-cell-role="th">problematic_content_label_present</th>
<th data-quarto-table-cell-role="th">problematic_content_label_agreement</th>
<th data-quarto-table-cell-role="th">language_names</th>
<th data-quarto-table-cell-role="th">language_code</th>
<th data-quarto-table-cell-role="th">label</th>
</tr>
<tr class="even">
<th>str</th>
<th>str</th>
<th>list[str]</th>
<th>list[str]</th>
<th>bool</th>
<th>f64</th>
<th>str</th>
<th>str</th>
<th>str</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"78889051-5d7e-4d33-9d3f-6414ba…</td>
<td>"المؤتمر العالمي للغابات يجتمع …</td>
<td>["None"]</td>
<td>["9e779e60-6719-401a-ab47-05aafb94be65"]</td>
<td>false</td>
<td>1.0</td>
<td>"arb_Arab"</td>
<td>"arb_Arab"</td>
<td>"None"</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="cell-19" class="cell" data-input="false" data-execution_count="9">
<details class="code-fold">
<summary>Click to show/hide code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>label_counts <span class="op">=</span> (</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    df.group_by([<span class="st">"language_code"</span>, <span class="st">"label"</span>])</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">len</span>()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    .pivot(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span><span class="st">"len"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="st">"language_code"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"label"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        aggregate_function<span class="op">=</span><span class="st">"sum"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    .fill_null(<span class="dv">0</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate row totals</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>row_totals <span class="op">=</span> label_counts.select(pl.exclude(<span class="st">"language_code"</span>)).sum_horizontal()</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate percentages</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>label_percentages <span class="op">=</span> (</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    label_counts.with_columns(</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        pl.col(col) <span class="op">/</span> row_totals <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> label_counts.columns</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="op">!=</span> <span class="st">"language_code"</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    .select([<span class="st">"language_code"</span>, pl.<span class="bu">all</span>().exclude(<span class="st">"language_code"</span>).<span class="bu">round</span>(<span class="dv">2</span>)])</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    .sort(<span class="st">"language_code"</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>label_percentages</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (17, 8)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">language_code</th>
<th data-quarto-table-cell-role="th">Good</th>
<th data-quarto-table-cell-role="th">Minimal</th>
<th data-quarto-table-cell-role="th">Excellent</th>
<th data-quarto-table-cell-role="th">❗ Problematic Content ❗</th>
<th data-quarto-table-cell-role="th">Basic</th>
<th data-quarto-table-cell-role="th">None</th>
<th data-quarto-table-cell-role="th">❗ Wrong language ❗</th>
</tr>
<tr class="even">
<th>str</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"arb_Arab"</td>
<td>2.5</td>
<td>15.6</td>
<td>0.7</td>
<td>25.3</td>
<td>4.9</td>
<td>51.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>"ary_Arab"</td>
<td>1.4</td>
<td>1.2</td>
<td>1.0</td>
<td>94.6</td>
<td>0.7</td>
<td>1.1</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>"arz_Arab"</td>
<td>4.0</td>
<td>3.7</td>
<td>2.0</td>
<td>73.5</td>
<td>4.1</td>
<td>12.7</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>"bar_Latn"</td>
<td>0.0</td>
<td>2.4</td>
<td>0.0</td>
<td>77.0</td>
<td>4.1</td>
<td>16.5</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>"cmn_Hani"</td>
<td>9.7</td>
<td>36.2</td>
<td>1.4</td>
<td>2.5</td>
<td>25.1</td>
<td>24.2</td>
<td>0.9</td>
</tr>
<tr class="even">
<td>"dan_Latn"</td>
<td>1.2</td>
<td>28.2</td>
<td>0.1</td>
<td>14.5</td>
<td>8.4</td>
<td>47.6</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>"fas_Arab"</td>
<td>8.9</td>
<td>18.7</td>
<td>2.3</td>
<td>20.5</td>
<td>10.0</td>
<td>39.6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>"fil_Latn"</td>
<td>2.6</td>
<td>27.6</td>
<td>0.8</td>
<td>37.9</td>
<td>5.1</td>
<td>24.1</td>
<td>1.9</td>
</tr>
<tr class="odd">
<td>"fin_Latn"</td>
<td>18.2</td>
<td>28.5</td>
<td>2.6</td>
<td>8.5</td>
<td>20.6</td>
<td>19.7</td>
<td>1.9</td>
</tr>
<tr class="even">
<td>"fra_Latn"</td>
<td>5.7</td>
<td>23.8</td>
<td>2.8</td>
<td>4.8</td>
<td>8.6</td>
<td>54.3</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>"gmh_Latn"</td>
<td>0.0</td>
<td>0.5</td>
<td>0.0</td>
<td>98.3</td>
<td>0.2</td>
<td>1.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>"hin_Deva"</td>
<td>0.2</td>
<td>11.2</td>
<td>0.3</td>
<td>0.3</td>
<td>0.9</td>
<td>87.1</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>"lvs_Latn"</td>
<td>1.4</td>
<td>23.8</td>
<td>0.0</td>
<td>8.7</td>
<td>11.4</td>
<td>54.7</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>"rus_Cyrl"</td>
<td>3.0</td>
<td>13.9</td>
<td>1.1</td>
<td>7.6</td>
<td>6.1</td>
<td>68.3</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>"slk_Latn"</td>
<td>3.8</td>
<td>21.6</td>
<td>1.5</td>
<td>4.7</td>
<td>8.0</td>
<td>60.4</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>"tat_Cyrl"</td>
<td>3.87</td>
<td>23.8</td>
<td>1.19</td>
<td>3.69</td>
<td>21.3</td>
<td>46.16</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>"vie_Latn"</td>
<td>6.4</td>
<td>33.9</td>
<td>1.2</td>
<td>9.5</td>
<td>13.1</td>
<td>35.9</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>This is a bit hard to read so let’s plot it as a heatmap.</p>
<div id="cell-21" class="cell" data-input="false" data-execution_count="10">
<details class="code-fold">
<summary>Click to show/hide code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Polars DataFrame to pandas for seaborn</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>label_percentages_pd <span class="op">=</span> label_percentages.to_pandas()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up column names by replacing the problematic symbols</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>label_percentages_pd.columns <span class="op">=</span> [</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    col.replace(<span class="st">"❗"</span>, <span class="st">"!"</span>) <span class="cf">for</span> col <span class="kw">in</span> label_percentages_pd.columns</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the desired column order</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>column_order <span class="op">=</span> [</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"None"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Basic"</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Minimal"</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Good"</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Excellent"</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"! Problematic Content !"</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"! Wrong language !"</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder the columns (excluding 'language_code' which will be the index)</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>label_percentages_pd <span class="op">=</span> label_percentages_pd.set_index(<span class="st">"language_code"</span>)[column_order]</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>sns.heatmap(</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    label_percentages_pd,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    annot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">=</span><span class="st">".1f"</span>,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"YlOrRd"</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    cbar_kws<span class="op">=</span>{<span class="st">"label"</span>: <span class="st">"Percentage (%)"</span>},</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    square<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">"right"</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Labels by Language (%)"</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="how-fine-is-fineweb2_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can also look at the distribution of labels as a bar chart.</p>
<div id="cell-23" class="cell" data-input="false" data-execution_count="11">
<details class="code-fold">
<summary>Click to show/hide code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the wide-format data to long format for Altair</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">=</span> label_percentages.unpivot(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>[<span class="st">"language_code"</span>],</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>label_percentages.columns[<span class="dv">1</span>:],  <span class="co"># All columns except language_code</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    variable_name<span class="op">=</span><span class="st">"label"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">"percentage"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the Altair chart</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>chart <span class="op">=</span> (</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    alt.Chart(plot_df)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    .mark_bar()</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    .encode(</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"language_code"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>alt.Y(<span class="st">"percentage"</span>, stack<span class="op">=</span><span class="st">"zero"</span>),</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"label"</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        tooltip<span class="op">=</span>[<span class="st">"language_code"</span>, <span class="st">"label"</span>, <span class="st">"percentage"</span>],</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    .properties(width<span class="op">=</span><span class="dv">600</span>, height<span class="op">=</span><span class="dv">400</span>, title<span class="op">=</span><span class="st">"Label Distribution by Language"</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    .configure_axis(labelAngle<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>chart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">

<style>
  #altair-viz-547283e6327c4f12b24668fe7d3eab14.vega-embed {
    width: 100%;
    display: flex;
  }

  #altair-viz-547283e6327c4f12b24668fe7d3eab14.vega-embed details,
  #altair-viz-547283e6327c4f12b24668fe7d3eab14.vega-embed details summary {
    position: relative;
  }
</style>
<div id="altair-viz-547283e6327c4f12b24668fe7d3eab14"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-547283e6327c4f12b24668fe7d3eab14") {
      outputDiv = document.getElementById("altair-viz-547283e6327c4f12b24668fe7d3eab14");
    }

    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm/vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm/vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm/vega-lite@5.20.1?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm/vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      let deps = ["vega-embed"];
      require(deps, displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "5.20.1"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 300, "continuousHeight": 300}, "axis": {"labelAngle": 45}}, "data": {"name": "data-e2d3e9d8c6350ff49c03d8ee1556b101"}, "mark": {"type": "bar"}, "encoding": {"color": {"field": "label", "type": "nominal"}, "tooltip": [{"field": "language_code", "type": "nominal"}, {"field": "label", "type": "nominal"}, {"field": "percentage", "type": "quantitative"}], "x": {"field": "language_code", "type": "nominal"}, "y": {"field": "percentage", "stack": "zero", "type": "quantitative"}}, "height": 400, "title": "Label Distribution by Language", "width": 600, "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json", "datasets": {"data-e2d3e9d8c6350ff49c03d8ee1556b101": [{"language_code": "arb_Arab", "label": "Good", "percentage": 2.5}, {"language_code": "ary_Arab", "label": "Good", "percentage": 1.4}, {"language_code": "arz_Arab", "label": "Good", "percentage": 4.0}, {"language_code": "bar_Latn", "label": "Good", "percentage": 0.0}, {"language_code": "cmn_Hani", "label": "Good", "percentage": 9.7}, {"language_code": "dan_Latn", "label": "Good", "percentage": 1.2}, {"language_code": "fas_Arab", "label": "Good", "percentage": 8.9}, {"language_code": "fil_Latn", "label": "Good", "percentage": 2.6}, {"language_code": "fin_Latn", "label": "Good", "percentage": 18.2}, {"language_code": "fra_Latn", "label": "Good", "percentage": 5.7}, {"language_code": "gmh_Latn", "label": "Good", "percentage": 0.0}, {"language_code": "hin_Deva", "label": "Good", "percentage": 0.2}, {"language_code": "lvs_Latn", "label": "Good", "percentage": 1.4}, {"language_code": "rus_Cyrl", "label": "Good", "percentage": 3.0}, {"language_code": "slk_Latn", "label": "Good", "percentage": 3.8}, {"language_code": "tat_Cyrl", "label": "Good", "percentage": 3.87}, {"language_code": "vie_Latn", "label": "Good", "percentage": 6.4}, {"language_code": "arb_Arab", "label": "Minimal", "percentage": 15.6}, {"language_code": "ary_Arab", "label": "Minimal", "percentage": 1.2}, {"language_code": "arz_Arab", "label": "Minimal", "percentage": 3.7}, {"language_code": "bar_Latn", "label": "Minimal", "percentage": 2.4}, {"language_code": "cmn_Hani", "label": "Minimal", "percentage": 36.2}, {"language_code": "dan_Latn", "label": "Minimal", "percentage": 28.2}, {"language_code": "fas_Arab", "label": "Minimal", "percentage": 18.7}, {"language_code": "fil_Latn", "label": "Minimal", "percentage": 27.6}, {"language_code": "fin_Latn", "label": "Minimal", "percentage": 28.5}, {"language_code": "fra_Latn", "label": "Minimal", "percentage": 23.8}, {"language_code": "gmh_Latn", "label": "Minimal", "percentage": 0.5}, {"language_code": "hin_Deva", "label": "Minimal", "percentage": 11.2}, {"language_code": "lvs_Latn", "label": "Minimal", "percentage": 23.8}, {"language_code": "rus_Cyrl", "label": "Minimal", "percentage": 13.9}, {"language_code": "slk_Latn", "label": "Minimal", "percentage": 21.6}, {"language_code": "tat_Cyrl", "label": "Minimal", "percentage": 23.8}, {"language_code": "vie_Latn", "label": "Minimal", "percentage": 33.9}, {"language_code": "arb_Arab", "label": "Excellent", "percentage": 0.7}, {"language_code": "ary_Arab", "label": "Excellent", "percentage": 1.0}, {"language_code": "arz_Arab", "label": "Excellent", "percentage": 2.0}, {"language_code": "bar_Latn", "label": "Excellent", "percentage": 0.0}, {"language_code": "cmn_Hani", "label": "Excellent", "percentage": 1.4}, {"language_code": "dan_Latn", "label": "Excellent", "percentage": 0.1}, {"language_code": "fas_Arab", "label": "Excellent", "percentage": 2.3}, {"language_code": "fil_Latn", "label": "Excellent", "percentage": 0.8}, {"language_code": "fin_Latn", "label": "Excellent", "percentage": 2.6}, {"language_code": "fra_Latn", "label": "Excellent", "percentage": 2.8}, {"language_code": "gmh_Latn", "label": "Excellent", "percentage": 0.0}, {"language_code": "hin_Deva", "label": "Excellent", "percentage": 0.3}, {"language_code": "lvs_Latn", "label": "Excellent", "percentage": 0.0}, {"language_code": "rus_Cyrl", "label": "Excellent", "percentage": 1.1}, {"language_code": "slk_Latn", "label": "Excellent", "percentage": 1.5}, {"language_code": "tat_Cyrl", "label": "Excellent", "percentage": 1.19}, {"language_code": "vie_Latn", "label": "Excellent", "percentage": 1.2}, {"language_code": "arb_Arab", "label": "\u2757 Problematic Content \u2757", "percentage": 25.3}, {"language_code": "ary_Arab", "label": "\u2757 Problematic Content \u2757", "percentage": 94.6}, {"language_code": "arz_Arab", "label": "\u2757 Problematic Content \u2757", "percentage": 73.5}, {"language_code": "bar_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 77.0}, {"language_code": "cmn_Hani", "label": "\u2757 Problematic Content \u2757", "percentage": 2.5}, {"language_code": "dan_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 14.5}, {"language_code": "fas_Arab", "label": "\u2757 Problematic Content \u2757", "percentage": 20.5}, {"language_code": "fil_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 37.9}, {"language_code": "fin_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 8.5}, {"language_code": "fra_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 4.8}, {"language_code": "gmh_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 98.3}, {"language_code": "hin_Deva", "label": "\u2757 Problematic Content \u2757", "percentage": 0.3}, {"language_code": "lvs_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 8.7}, {"language_code": "rus_Cyrl", "label": "\u2757 Problematic Content \u2757", "percentage": 7.6}, {"language_code": "slk_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 4.7}, {"language_code": "tat_Cyrl", "label": "\u2757 Problematic Content \u2757", "percentage": 3.69}, {"language_code": "vie_Latn", "label": "\u2757 Problematic Content \u2757", "percentage": 9.5}, {"language_code": "arb_Arab", "label": "Basic", "percentage": 4.9}, {"language_code": "ary_Arab", "label": "Basic", "percentage": 0.7}, {"language_code": "arz_Arab", "label": "Basic", "percentage": 4.1}, {"language_code": "bar_Latn", "label": "Basic", "percentage": 4.1}, {"language_code": "cmn_Hani", "label": "Basic", "percentage": 25.1}, {"language_code": "dan_Latn", "label": "Basic", "percentage": 8.4}, {"language_code": "fas_Arab", "label": "Basic", "percentage": 10.0}, {"language_code": "fil_Latn", "label": "Basic", "percentage": 5.1}, {"language_code": "fin_Latn", "label": "Basic", "percentage": 20.6}, {"language_code": "fra_Latn", "label": "Basic", "percentage": 8.6}, {"language_code": "gmh_Latn", "label": "Basic", "percentage": 0.2}, {"language_code": "hin_Deva", "label": "Basic", "percentage": 0.9}, {"language_code": "lvs_Latn", "label": "Basic", "percentage": 11.4}, {"language_code": "rus_Cyrl", "label": "Basic", "percentage": 6.1}, {"language_code": "slk_Latn", "label": "Basic", "percentage": 8.0}, {"language_code": "tat_Cyrl", "label": "Basic", "percentage": 21.3}, {"language_code": "vie_Latn", "label": "Basic", "percentage": 13.1}, {"language_code": "arb_Arab", "label": "None", "percentage": 51.0}, {"language_code": "ary_Arab", "label": "None", "percentage": 1.1}, {"language_code": "arz_Arab", "label": "None", "percentage": 12.7}, {"language_code": "bar_Latn", "label": "None", "percentage": 16.5}, {"language_code": "cmn_Hani", "label": "None", "percentage": 24.2}, {"language_code": "dan_Latn", "label": "None", "percentage": 47.6}, {"language_code": "fas_Arab", "label": "None", "percentage": 39.6}, {"language_code": "fil_Latn", "label": "None", "percentage": 24.1}, {"language_code": "fin_Latn", "label": "None", "percentage": 19.7}, {"language_code": "fra_Latn", "label": "None", "percentage": 54.3}, {"language_code": "gmh_Latn", "label": "None", "percentage": 1.0}, {"language_code": "hin_Deva", "label": "None", "percentage": 87.1}, {"language_code": "lvs_Latn", "label": "None", "percentage": 54.7}, {"language_code": "rus_Cyrl", "label": "None", "percentage": 68.3}, {"language_code": "slk_Latn", "label": "None", "percentage": 60.4}, {"language_code": "tat_Cyrl", "label": "None", "percentage": 46.16}, {"language_code": "vie_Latn", "label": "None", "percentage": 35.9}, {"language_code": "arb_Arab", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "ary_Arab", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "arz_Arab", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "bar_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "cmn_Hani", "label": "\u2757 Wrong language \u2757", "percentage": 0.9}, {"language_code": "dan_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "fas_Arab", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "fil_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 1.9}, {"language_code": "fin_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 1.9}, {"language_code": "fra_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "gmh_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "hin_Deva", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "lvs_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "rus_Cyrl", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "slk_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "tat_Cyrl", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}, {"language_code": "vie_Latn", "label": "\u2757 Wrong language \u2757", "percentage": 0.0}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
</section>
</section>
<section id="refining-fineweb2-for-more-languages-aka-next-steps" class="level2">
<h2 class="anchored" data-anchor-id="refining-fineweb2-for-more-languages-aka-next-steps">Refining FineWeb2 for more languages aka next steps</h2>
<p>We can see that the distribution of labels varies a fair amount between languages. Some are mostly problematic labels whilst others have a much better distribution of labels. This can also inform what is the best next step for a languages as part of the FineWeb-C project.</p>
<section id="better-starting-data-for-annotators-aka-more-filtering-of-problematic-data" class="level3">
<h3 class="anchored" data-anchor-id="better-starting-data-for-annotators-aka-more-filtering-of-problematic-data">Better starting data for annotators aka more filtering of problematic data</h3>
<p>FineWeb2 already has a lot of filters to try and identify high quality data, however this is challenging to do across many many languages. This is why the community is so important.</p>
<ul>
<li>If a language has a lot of problematic or None labels it makes sense to focus on getting higher quality data filtered for that language.</li>
<li>In a previous <a href="https://danielvanstrien.xyz/posts/2024/12/23/fineweb-filter-polars.html">blog post</a> I showed some approaches to how this can be done for a single language. The best approach will depend on the language but developing better heuristics for more languages can be very impactful. <strong>This is another area where the community can help!</strong></li>
<li>Some languages have a lot of data that has been incorrectly identified as the wrong language. This is a problem for the community as it means annotators have to spend a lot of time annotating data that is not useful. For these languages <strong>if the community has better heuristics or models for identifying the wrong language we can filter out more data.</strong></li>
</ul>
</section>
<section id="evaluating-agreement-between-annotators" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-agreement-between-annotators">Evaluating agreement between annotators</h3>
<p>If a language has a good distribution of labels the next step is to try and look at the agreement between annotators. This can help us understand how much we can trust the labels and also help us understand where the labels are ambiguous.</p>
</section>
<section id="evaluating-llms-to-build-training-data-for-a-classifier" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-llms-to-build-training-data-for-a-classifier">Evaluating LLMs to build training data for a classifier?</h3>
<p>For languages where we have fairly good agreement (or at least a subset of good agreement) we can already start to evaluate how well LLMs can do at identifying educational content. Remembering back to the overall goal of this effort, is to reproduce something similar to FineWeb-Edu. This is a subset of the original FineWeb dataset which has been filtered for educational content. This filtering was done by first training a classifier on the original FineWeb-Edu dataset and then using this classifier to filter the original FineWeb dataset. That classifier was training on labels generated by Llama. For some languages it might be possible to take a similar approach. We can do something like:</p>
<ul>
<li>Evaluate how well an LLM does in comparison to our annotators. This might require experimenting with different LLMs and prompting approaches. I’m working on a notebook to do this but <strong>this is another area where the community can help.</strong></li>
<li>If the LLM does a good job we can then use it to create enough data to start to train a classifier.</li>
</ul>
</section>
<section id="training-educational-quality-classifiers" class="level3">
<h3 class="anchored" data-anchor-id="training-educational-quality-classifiers">Training educational quality classifiers</h3>
<p>Some languages already have quite a lot of data with a fairly good distribution of labels. For these languages we can already see if we have sufficient data to train a classifier. It’s likely for most languages we’d need more data but starting to train a classifier can be a good next step. <strong>Again this is another area where the community can help!</strong></p>
<p>As you may have noticed, I’ve been using the word “community” a lot in this post. This is because I think this is a really important part of the FineWeb-C project. We have a <a href="https://discord.com/channels/879548962464493619/1326130187527651348">Discord channel</a> where we can discuss the project and share ideas. If you’re interested in contributing to the project please join the channel and let’s chat!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/danielvanstrien\.xyz");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>