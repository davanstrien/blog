<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel van Strien">
<meta name="dcterms.date" content="2024-09-23">
<meta name="description" content="Learn how to generate custom ColPali dataset using an open VLM for multimodal retrieval model training and fine-tuning.">

<title>Generating a dataset of queries for training and fine-tuning ColPali models on a UFO dataset – Daniel van Strien</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../icons/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-659650fc26dc25888fc1474f317bb8ac.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="85cb27d6-dbf9-43d7-97d0-be4e6724de7a"></script>
<meta name="msvalidate.01" content="4246174F24A3CB7C9CBEAA94E1FF8E84">
<meta name="google-site-verification" content="C7WoFOEuA4Msbvvk-kgDd_C6VGphZTp3awy_acXjZYU">


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Daniel van Strien</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/davanstrien"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/vanstriendaniel"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction-to-colpali" id="toc-introduction-to-colpali" class="nav-link active" data-scroll-target="#introduction-to-colpali">Introduction to ColPali</a></li>
  <li><a href="#how-copali-works" id="toc-how-copali-works" class="nav-link" data-scroll-target="#how-copali-works">How CoPali works?</a>
  <ul class="collapse">
  <li><a href="#the-training-data-for-colpali" id="toc-the-training-data-for-colpali" class="nav-link" data-scroll-target="#the-training-data-for-colpali">The training data for ColPali</a></li>
  </ul></li>
  <li><a href="#creating-queries-from-documents" id="toc-creating-queries-from-documents" class="nav-link" data-scroll-target="#creating-queries-from-documents">Creating queries from documents</a></li>
  <li><a href="#ufo-colpali-creating-a-domain-specific-dataset" id="toc-ufo-colpali-creating-a-domain-specific-dataset" class="nav-link" data-scroll-target="#ufo-colpali-creating-a-domain-specific-dataset">UFO ColPali: creating a domain specific dataset</a></li>
  <li><a href="#using-qwen2-vl-to-generate-queries" id="toc-using-qwen2-vl-to-generate-queries" class="nav-link" data-scroll-target="#using-qwen2-vl-to-generate-queries">Using Qwen2-VL to generate queries</a></li>
  <li><a href="#building-colpali-queries" id="toc-building-colpali-queries" class="nav-link" data-scroll-target="#building-colpali-queries">Building Colpali queries</a>
  <ul class="collapse">
  <li><a href="#validating-the-responses" id="toc-validating-the-responses" class="nav-link" data-scroll-target="#validating-the-responses">Validating the responses</a></li>
  </ul></li>
  <li><a href="#an-update-retrieval-focused-prompt" id="toc-an-update-retrieval-focused-prompt" class="nav-link" data-scroll-target="#an-update-retrieval-focused-prompt">An update retrieval focused prompt</a></li>
  <li><a href="#generating-the-full-dataset" id="toc-generating-the-full-dataset" class="nav-link" data-scroll-target="#generating-the-full-dataset">Generating the full dataset</a></li>
  <li><a href="#pushing-to-the-hub" id="toc-pushing-to-the-hub" class="nav-link" data-scroll-target="#pushing-to-the-hub">Pushing to the Hub</a></li>
  <li><a href="#conclusion-improvements-and-next-steps" id="toc-conclusion-improvements-and-next-steps" class="nav-link" data-scroll-target="#conclusion-improvements-and-next-steps">Conclusion, improvements and next steps</a>
  <ul class="collapse">
  <li><a href="#structured-generation" id="toc-structured-generation" class="nav-link" data-scroll-target="#structured-generation">Structured Generation</a></li>
  <li><a href="#more-diverse-queries" id="toc-more-diverse-queries" class="nav-link" data-scroll-target="#more-diverse-queries">More diverse queries</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul></li>
  <li><a href="#appendix-more-diverse-queries" id="toc-appendix-more-diverse-queries" class="nav-link" data-scroll-target="#appendix-more-diverse-queries">Appendix more diverse queries</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Generating a dataset of queries for training and fine-tuning ColPali models on a UFO dataset</h1>
</div>

<div>
  <div class="description">
    Learn how to generate custom ColPali dataset using an open VLM for multimodal retrieval model training and fine-tuning.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel van Strien </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 23, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><a href="https://colab.research.google.com/github/davanstrien/blog/blob/main/posts/post-with-code/colpali/2024-09-23-generate_colpali_dataset.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" class="img-fluid"></a></p>
<p><strong>updates</strong></p>
<ul>
<li>You can find a follow up blog post on <a href="https://danielvanstrien.xyz/posts/post-with-code/colpali-qdrant/2024-10-02_using_colpali_with_qdrant.html">using ColPali with Qdrant</a> which covers how to use the fine-tuned ColPali model with the Qdrant vector database to implement a multimodal retrieval pipeline.</li>
</ul>
<section id="introduction-to-colpali" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-colpali">Introduction to ColPali</h2>
<p>tl;dr this blog post covers how to generate a dataset for training/fine-tuning ColPali models an open VLM to generate queries. You can find the dataset produced by this approach <a href="https://huggingface.co/datasets/davanstrien/ufo-ColPali">here</a>.</p>
<p>ColPali is a new multimodal approach to retrieval which aims to replace existing document retrievers which often rely on an OCR step with an end-to-end multimodal approach. This approach also aims to take into account the visual content and layout of the documents, in addition to the textual content. Looking at an example of a document:</p>
<p><img src="doc.png" class="img-fluid"></p>
<p>we could rely only on the text, but the page also has a table which could be relevant for retrieving the most useful document either for direct use or in a RAG pipeline. In many documents we will find that pages don’t just contain images but also other rich sources of visual information that could be relevant for retrieval.</p>
</section>
<section id="how-copali-works" class="level2">
<h2 class="anchored" data-anchor-id="how-copali-works">How CoPali works?</h2>
<p>ColPali is a document retrieval model that leverages a Vision Language Model (VLM) to understand and retrieve documents based on their visual content. The key steps are:</p>
<ul>
<li>Document Encoding: ColPali takes document pages as images and processes them through a VLM (specifically, PaliGemma-3B) to generate embeddings for each image patch.</li>
<li>Query Encoding: User queries are encoded using the same VLM’s text processing capabilities.</li>
<li>Late Interaction: Instead of comparing a single vector per document, ColPali uses a “late interaction” mechanism that compares each query token embedding to all document patch embeddings.</li>
</ul>
<p>Scoring: The relevance score between a query and a document is computed by summing the maximum similarities between each query token and all document patches.</p>
<p>This approach allows ColPali to understand both textual and visual elements in documents, enabling more comprehensive and accurate retrieval compared to traditional text-only methods. It eliminates the need for complex document parsing pipelines, as it works directly with document images.</p>
<p>Whilst, late interaction methods have some additional computational costs, for many documents with rich visual content there is also a high potential processing cost in the document parsing pipeline — and this pipeline can also be rather brittle.</p>
<section id="the-training-data-for-colpali" class="level3">
<h3 class="anchored" data-anchor-id="the-training-data-for-colpali">The training data for ColPali</h3>
<p>Let’s take a look at what the training data looks like for training ColPali.</p>
<iframe src="https://huggingface.co/datasets/vidore/colpali_train_set/embed/viewer/default/train" frameborder="0" width="100%" height="560px">
</iframe>
<p>You’ll see that each row contains a bunch of metadata about the source of the document and other information but the key parts for the actual training of the model are the image and the queries pairs. When training ColPali we want a dataset of images with queries that relate to the image. This will allow the model to learn how queries are related to the images. To help the model learn it can also be helpful to have negative examples.</p>
<p>Let’s take a closer look at a few examples from the data before we jump into generating our own.</p>
<p>For this notebook I’m using <code>uv</code> to manage Python installs because I find it to be a lot quicker but you can use <code>pip</code> if you prefer.</p>
<div id="cell-5" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install uv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting uv
  Downloading uv-0.4.15-py3-none-macosx_11_0_arm64.whl.metadata (11 kB)
Downloading uv-0.4.15-py3-none-macosx_11_0_arm64.whl (10.9 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 10.9/10.9 MB 22.7 MB/s eta 0:00:001m22.2 MB/s eta 0:00:01
Installing collected packages: uv
Successfully installed uv-0.4.15
Note: you may need to restart the kernel to use updated packages.</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-outputid="17fc22ef-46e9-4008-d83f-02dfba8d3051" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>uv pip install accelerate qwen<span class="op">-</span>vl<span class="op">-</span>utils torchvision torch datasets huggingface_hub[hf_transfer] polars <span class="op">--</span>system</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>uv pip install git<span class="op">+</span>https:<span class="op">//</span>github.com<span class="op">/</span>huggingface<span class="op">/</span>transformers.git  <span class="op">--</span>system</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Audited 6 packages in 11ms
Resolved 54 packages in 230ms                                        
Audited 54 packages in 0.08ms</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>uv pip install flash<span class="op">-</span>attn <span class="op">--</span>no<span class="op">-</span>build<span class="op">-</span>isolation <span class="op">--</span>system</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Audited 1 package in 6ms</code></pre>
</div>
</div>
<p>We can take a look at a few examples from the data using Polars.</p>
<div id="cell-9" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> {<span class="st">"train"</span>: <span class="st">"data/train-*.parquet"</span>, <span class="st">"test"</span>: <span class="st">"data/test-00000-of-00001.parquet"</span>}</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pl.scan_parquet(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hf://datasets/vidore/colpali_train_set/"</span> <span class="op">+</span> splits[<span class="st">"train"</span>],</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see what columns we have in the dataset.</p>
<div id="cell-11" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>['image',
 'image_filename',
 'query',
 'answer',
 'source',
 'options',
 'page',
 'model',
 'prompt',
 'answer_type']</code></pre>
</div>
</div>
<p>Since we’re shortly going to turn to how we can generate our own queries, let’s take a look at a few examples from the data. We’ll filter to focus on the <code>pdf</code> source, since these are the ones created by the authors of ColPali (the other sources are from existing datasets).</p>
<div id="cell-13" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>filtered_df <span class="op">=</span> (</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    df.<span class="bu">filter</span>(pl.col(<span class="st">"source"</span>).<span class="bu">str</span>.contains(<span class="st">"pdf"</span>)).select([<span class="st">"query"</span>]).head(<span class="dv">10</span>).collect()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>query_list <span class="op">=</span> filtered_df[<span class="st">"query"</span>].to_list()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>query_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>['What is the duration of the course mentioned in the image?',
 'What is the primary purpose of the PTC in lithium batteries?',
 'How is the baseline CO2 emissions calculated for affected EGUs in the low load natural gas-fired or oil-fired subcategories?',
 'What are some suggestions Liberty Medical Group should consider to improve their accounts receivable turnover and days sales in receivables ratios?',
 'What measures will the Secretary determine to assess the quality of care furnished by the ACO?',
 'How is the CT kerma index measured?',
 'What is the difference between hindsight and foresight according to the passage?',
 'How are the vapor jets arranged during the transitional and film boiling regimes?',
 'What types of batteries are covered by the European Union Batteries Directive?',
 'What are some factors to consider for CAES facility development in different parts of New York?']</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>One thing you might notice about these queries is that many of them are more focused on “questions” about documents rather than traditional search queries. We’ll shortly see the prompting approach used to generate these queries but we might already want to consider, depending on our use case, whether we want to generate more “search”-like queries or more “question”-like queries.</p>
</div>
</div>
</section>
</section>
<section id="creating-queries-from-documents" class="level2">
<h2 class="anchored" data-anchor-id="creating-queries-from-documents">Creating queries from documents</h2>
<p>For the data using in ColPali, part of the dataset was sourced from existing document question answering datasets. Another component was generated using Claude 3.0 Sonnet with the following prompt:</p>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="st">You are an assistant specialized in Multimodal RAG tasks.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">The task is the following: given an image from a pdf page, you will have to generate questions that can be asked by a user to retrieve information from a large documentary corpus.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">The question should be relevant to the page, and should not be too specific or too general. The question should be about the subject of the page, and the answer needs to be found in the page.</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="st">Remember that the question is asked by a user to get some information from a large documentary corpus that contains multimodal data. Generate a question that could be asked by a user without knowing the existence and the content of the corpus.</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="st">Generate as well the answer to the question, which should be found in the page. And the format of the answer should be a list of words answering the question.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="st">Generate at most THREE pairs of questions and answers per page in a dictionary with the following format, answer ONLY this dictionary NOTHING ELSE:</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="st">    "questions": [</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="st">        {</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="st">            "question": "XXXXXX",</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="st">            "answer": ["YYYYYY"]</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="st">        },</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="st">        {</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="st">            "question": "XXXXXX",</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="st">            "answer": ["YYYYYY"]</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="st">        },</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="st">        {</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="st">            "question": "XXXXXX",</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="st">            "answer": ["YYYYYY"]</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="st">    ]</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="st">where XXXXXX is the question and ['YYYYYY'] is the corresponding list of answers that could be as long as needed.</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="st">Note: If there are no questions to ask about the page, return an empty list. Focus on making relevant questions concerning the page.</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the page:"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see this prompt is focused on generating questions that are relevant to the page and that could be asked by a user and answered by the document. One thing I noticed from the queries generated with this prompt is that I think some of the generated queries strayed a bit from the prompts request to not assume the user knew the content of the document. Some of the questions were quite specific and it seemed like they were tailored to the particular page they were generated from.</p>
<p>Whilst out of the box performance of ColPali is likely to be good for many domains and use cases it it likely that fine tuning ColPali on domain specific data will lead to improved performance. We’ll now turn to how we can generate our own queries for ColPali.</p>
</section>
<section id="ufo-colpali-creating-a-domain-specific-dataset" class="level2">
<h2 class="anchored" data-anchor-id="ufo-colpali-creating-a-domain-specific-dataset">UFO ColPali: creating a domain specific dataset</h2>
<p>Let’s now turn to how we could approach generating our own query image pairs for training — or more likely fine tuning — a ColPali model on domain specific data.</p>
<p>To make the example slightly more interesting we’ll stray away from using an existing document dataset and use a UFO dateset which has been sourced from an Internet Archive <a href="https://archive.org/details/ufonewsletters">Collection of UFO newsletters</a>. This dataset was created from a sample of PDFs from this collection which were then split into single page images using the <a href="https://huggingface.co/spaces/Dataset-Creation-Tools/pdf-to-page-images-dataset">pdf-to-page-images-dataset</a> Hugging Face Space. If you have a collection of PDFs related to your domain you could also use this Space to quickly create a dataset for your use case.</p>
<div id="cell-19" class="cell" data-outputid="7d9282e5-2c9b-4894-d480-e916ae940681">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you are running on a machine with quite a fast connection, the following environment variable may increase the speed of the model and dataset downloads.</p>
<div id="cell-21" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"HF_HUB_ENABLE_HF_TRANSFER"</span>] <span class="op">=</span> <span class="st">"1"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start by loading the UFO dataset and taking a look at a few examples.</p>
<div id="cell-23" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> load_dataset(<span class="st">"davanstrien/ufo"</span>, split<span class="op">=</span><span class="st">"train"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"53bf7962827a4f6988385597615e47ee","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Let’s see what a row looks like</p>
<div id="cell-25" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ds[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'image': &lt;PIL.JpegImagePlugin.JpegImageFile image mode=RGB size=596x842&gt;}</code></pre>
</div>
</div>
<p>and look at an example document</p>
<div id="cell-27" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ds[<span class="dv">3</span>][<span class="st">"image"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>
<figure class="figure">
<p><img src="2024-09-23-generate_colpali_dataset_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see that the dataset currently just contains images which map to a single page of a document. We can also see from the example document that the document does contain some visual elements which could be relevant for retrieval.</p>
<p>What we need to train or fine tune ColPali is at least one query for each of our the document images in our dataset.</p>
</section>
<section id="using-qwen2-vl-to-generate-queries" class="level2">
<h2 class="anchored" data-anchor-id="using-qwen2-vl-to-generate-queries">Using Qwen2-VL to generate queries</h2>
<p>Whilst the original ColPali paper used the Claude 3.0 Sonnet model to generate queries for the UFO dataset, we’ll use the Qwen2-VL model to generate queries for our UFO dataset. Specifcally we’ll use the 7B variant of the model (<a href="https://huggingface.co/Qwen/Qwen2-VL-7B-Instruct">Qwen/Qwen2-VL-7B-Instruct</a>). This is an open VLLM (Apache 2.0 licensed) Vision Language Model which has shown strong performance on a variety of vision and language tasks. Whilst the model won’t run on a standard T4 Google Colab instance we can run the model either on a L4 or an A100 GPU on Google Colab or you can use the Hugging Face Jupyter Spaces <a href="https://huggingface.co/spaces/SpacesExamples/jupyterlab?duplicate=true">template</a> to run the model on an L40s as I did.</p>
<p>To start let’s load the model and get a sense of how we can use it. We’ll do this through the Transformers library. It’s also possible to run the model using the vLLM library but since we’re only focusing on generating a relatively small number of queries this extra set up probably isn’t worth it in this case (I’d be interested to hear in the comments if you try it out and how it goes).</p>
<p>To start we’ll load the model. We’ll use <code>flash_attention_2</code> which should help a bit with the performance and memory usage of the model.</p>
<div id="cell-31" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> Qwen2VLForConditionalGeneration, AutoTokenizer, AutoProcessor</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qwen_vl_utils <span class="im">import</span> process_vision_info</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Qwen2VLForConditionalGeneration.from_pretrained(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Qwen/Qwen2-VL-7B-Instruct"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    torch_dtype<span class="op">=</span>torch.bfloat16,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    attn_implementation<span class="op">=</span><span class="st">"flash_attention_2"</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    device_map<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Unrecognized keys in `rope_scaling` for 'rope_type'='default': {'mrope_section'}
You are attempting to use Flash Attention 2.0 without specifying a torch dtype. This might lead to unexpected behaviour
`Qwen2VLRotaryEmbedding` can now be fully parameterized by passing the model config through the `config` argument. All other arguments will be removed in v4.46</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e46643d6608f466f9137cb8ad76cbc63","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>We next define the processor. This is the component that will help us prepare the inputs for the model.</p>
<div id="cell-33" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default processer</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>processor <span class="op">=</span> AutoProcessor.from_pretrained(<span class="st">"Qwen/Qwen2-VL-7B-Instruct"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As with many more recent models, we can use a chat template to help us prepare the inputs for the model. Here is the example from the Qwen2-VL-7B-Instruct model card.</p>
<div id="cell-35" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> [</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"content"</span>: [</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"image"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">"image"</span>: <span class="st">"https://qianwen-res.oss-cn-beijing.aliyuncs.com/Qwen-VL/assets/demo.jpeg"</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"type"</span>: <span class="st">"text"</span>, <span class="st">"text"</span>: <span class="st">"Describe this image."</span>},</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now pass this to the processor to get the inputs ready for the model. You’ll see here we first pass in the messages to the <code>apply_chat_template</code> method of the processor and then use the <code>process_vision_info</code> helper function which comes from the <code>qwen_vl_utils</code> library to prepare images and videos (which are not relevant here).</p>
<div id="cell-37" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> processor.apply_chat_template(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    messages, tokenize<span class="op">=</span><span class="va">False</span>, add_generation_prompt<span class="op">=</span><span class="va">True</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>image_inputs, video_inputs <span class="op">=</span> process_vision_info(messages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we take a look at the <code>text</code> we can see that the processor has applied a chat template to the messages.</p>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now pass the text, image and video inputs (in this case <code>None</code>) to the processor and prepare the inputs for the model.</p>
<div id="cell-41" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> processor(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>[text],</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    images<span class="op">=</span>image_inputs,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    videos<span class="op">=</span>video_inputs,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    padding<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    return_tensors<span class="op">=</span><span class="st">"pt"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> inputs.to(<span class="st">"cuda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>we can see what this input looks like</p>
<div id="cell-43" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>inputs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>{'input_ids': tensor([[151644,   8948,    198,  ..., 151644,  77091,    198]],
       device='cuda:0'), 'attention_mask': tensor([[1, 1, 1,  ..., 1, 1, 1]], device='cuda:0'), 'pixel_values': tensor([[ 0.8501,  0.8501,  0.8647,  ...,  1.3922,  1.3922,  1.3922],
        [ 0.9376,  0.9376,  0.9376,  ...,  1.4491,  1.4491,  1.4491],
        [ 0.9084,  0.9376,  0.9376,  ...,  1.4065,  1.4207,  1.4207],
        ...,
        [-0.1280, -0.1280, -0.1426,  ..., -0.2431, -0.2715, -0.3000],
        [-0.3324, -0.3324, -0.3032,  ..., -0.3000, -0.2715, -0.2857],
        [-0.3762, -0.4054, -0.4054,  ..., -0.4279, -0.4422, -0.4564]],
       device='cuda:0'), 'image_grid_thw': tensor([[  1,  98, 146]], device='cuda:0')}</code></pre>
</div>
</div>
<p>Now the inputs are ready to pass to the model. BTW, all of this inference code is copied straight from the Qwen2-VL-7B-Instruct model card on Hugging Face. There are a few things we might want to tweak but the basic examples are pretty much all we need for our use case.</p>
<div id="cell-45" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>generated_ids <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>generated_ids_trimmed <span class="op">=</span> [</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    out_ids[<span class="bu">len</span>(in_ids) :] <span class="cf">for</span> in_ids, out_ids <span class="kw">in</span> <span class="bu">zip</span>(inputs.input_ids, generated_ids)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>output_text <span class="op">=</span> processor.batch_decode(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    generated_ids_trimmed, skip_special_tokens<span class="op">=</span><span class="va">True</span>, clean_up_tokenization_spaces<span class="op">=</span><span class="va">False</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>output_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>["The image depicts a serene beach scene with a woman and her dog enjoying a moment together. The woman is sitting on the sandy beach, facing the ocean, and appears to be engaging in a playful activity with her dog. She is wearing a plaid shirt and dark pants, and her hair is long and dark. The dog, which is a large breed, possibly a Labrador Retriever, is sitting in front of her, wearing a harness. The dog is extending its front paw towards the woman's hand, as if they are giving each other a high-five. The woman is smiling, indicating a joyful interaction.\n\nThe beach is relatively empty, with gentle waves lapping at the shore. The sky is clear, and the sun is low on the horizon, casting a warm, golden light over the scene. The lighting suggests that the photo was taken either in the early morning or late afternoon, creating a peaceful and tranquil atmosphere. The sand is smooth and lightly textured, typical of a well-m"]</code></pre>
</div>
</div>
</section>
<section id="building-colpali-queries" class="level2">
<h2 class="anchored" data-anchor-id="building-colpali-queries">Building Colpali queries</h2>
<p>We now have a sense of how to generate responses using both a text and image input using the Qwen2-VL-7B-Instruct model. We’ll now use this model to generate queries for our UFO dataset. To start, let’s see how the prompt from the paper looks. The only thing we modified from the original prompt was to ask for JSON output rather than dictionaries since this model seemed to work better with this approach in my (somewhat limited) testing.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="st">You are an assistant specialized in Multimodal RAG tasks.</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="st">The task is the following: given an image from a pdf page, you will have to generate questions that can be asked by a user to retrieve information from a large documentary corpus.</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="st">The question should be relevant to the page, and should not be too specific or too general. The question should be about the subject of the page, and the answer needs to be found in the page.</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="st">Remember that the question is asked by a user to get some information from a large documentary corpus that contains multimodal data. Generate a question that could be asked by a user without knowing the existence and the content of the corpus.</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="st">Generate as well the answer to the question, which should be found in the page. And the format of the answer should be a list of words answering the question.</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="st">Generate at most THREE pairs of questions and answers per page as JSON with the following format, answer ONLY using JSON, NOTHING ELSE:</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="st">    "questions": [</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="st">        {</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="st">            "question": "XXXXXX",</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="st">            "answer": ["YYYYYY"]</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="st">        },</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="st">        {</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="st">            "question": "XXXXXX",</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="st">            "answer": ["YYYYYY"]</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="st">        },</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="st">        {</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="st">            "question": "XXXXXX",</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="st">            "answer": ["YYYYYY"]</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="st">    ]</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="st">where XXXXXX is the question and ['YYYYYY'] is the corresponding list of answers that could be as long as needed.</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="st">Note: If there are no questions to ask about the page, return an empty list. Focus on making relevant questions concerning the page.</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the page:</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We’ll copy and paste all of the previous code to generate a response from the model for an example from our UFO dataset. We’ll wrap this in a function once we’ve got a better sense of what we’re looking for.</p>
<div id="cell-49" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> [</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"content"</span>: [</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"image"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">"image"</span>: ds[<span class="dv">0</span>][<span class="st">"image"</span>],</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"type"</span>: <span class="st">"text"</span>, <span class="st">"text"</span>: prompt},</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-50" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> processor.apply_chat_template(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    messages, tokenize<span class="op">=</span><span class="va">False</span>, add_generation_prompt<span class="op">=</span><span class="va">True</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>image_inputs, video_inputs <span class="op">=</span> process_vision_info(messages)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> processor(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>[text],</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    images<span class="op">=</span>image_inputs,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    videos<span class="op">=</span>video_inputs,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    padding<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    return_tensors<span class="op">=</span><span class="st">"pt"</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> inputs.to(<span class="st">"cuda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>generated_ids <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>generated_ids_trimmed <span class="op">=</span> [</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    out_ids[<span class="bu">len</span>(in_ids) :] <span class="cf">for</span> in_ids, out_ids <span class="kw">in</span> <span class="bu">zip</span>(inputs.input_ids, generated_ids)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>output_text <span class="op">=</span> processor.batch_decode(</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    generated_ids_trimmed, skip_special_tokens<span class="op">=</span><span class="va">True</span>, clean_up_tokenization_spaces<span class="op">=</span><span class="va">False</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>output_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>['{\n    "questions": [\n        {\n            "question": "What is the main subject of the page?",\n            "answer": ["astronomy", "space exploration", "New York Times"]\n        },\n        {\n            "question": "What is the significance of the Sun newspaper in the context of the page?",\n            "answer": ["published a report attributed to an astronomer", "founded by Sir John Herschel", "published a report on the discovery of a race of singing aliens"]\n        },\n        {\n            "question": "What is the main event mentioned in the page?",\n            "answer": ["discovery of singing aliens on the Moon"]\n        }\n    ]\n}']</code></pre>
</div>
</div>
<p>You’ll see we get some responses like this <code>"What is the main event mentioned in the page?"</code> which is a bit too specific and tailored to the particular page. There are a few reasons this might be happening but the first thing we should play around with is changing the prompt.</p>
<section id="validating-the-responses" class="level3">
<h3 class="anchored" data-anchor-id="validating-the-responses">Validating the responses</h3>
<p>One of the big challenges you can have in generating synthetic data at scale is ensuring that you get valid responses that you can use in downstream tasks for training without having to do a lot of manual verification. Let’s see if we can load the response as valid JSON</p>
<div id="cell-54" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-55" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>json.loads(output_text[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>{'questions': [{'question': 'What is the main subject of the page?',
   'answer': ['astronomy', 'space exploration', 'New York Times']},
  {'question': 'What is the significance of the Sun newspaper in the context of the page?',
   'answer': ['published a report attributed to an astronomer',
    'founded by Sir John Herschel',
    'published a report on the discovery of a race of singing aliens']},
  {'question': 'What is the main event mentioned in the page?',
   'answer': ['discovery of singing aliens on the Moon']}]}</code></pre>
</div>
</div>
<div id="cell-56" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(output_text[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    "questions": [
        {
            "question": "What is the main subject of the page?",
            "answer": ["astronomy", "space exploration", "New York Times"]
        },
        {
            "question": "What is the significance of the Sun newspaper in the context of the page?",
            "answer": ["published a report attributed to an astronomer", "founded by Sir John Herschel", "published a report on the discovery of a race of singing aliens"]
        },
        {
            "question": "What is the main event mentioned in the page?",
            "answer": ["discovery of singing aliens on the Moon"]
        }
    ]
}</code></pre>
</div>
</div>
<p>Having a valid JSON is a good start but in many synthetic data generation tasks, people are increasingly using Pydantic to ensure outputs are valid in other ways. Let’s take a look at a rewritten prompt I created for generating queries. In this prompt we ask the VLLM model to generate 3 different types of retrieval queries:</p>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""You are an AI assistant specialized in document retrieval tasks. Given an image of a document page, your task is to generate retrieval queries that someone might use to find this document in a large corpus.</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="st">Please generate 3 different types of retrieval queries:</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="st">1. A broad topical query: This should cover the main subject of the document.</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="st">2. A specific detail query: This should focus on a particular fact, figure, or point made in the document.</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="st">3. A visual element query: This should reference a chart, graph, image, or other visual component in the document, if present.</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="st">Important guidelines:</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="st">- Ensure the queries are relevant for retrieval tasks, not just describing the page content.</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="st">- Frame the queries as if someone is searching for this document, not asking questions about its content.</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="st">- Make the queries diverse and representative of different search strategies.</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, also provide a brief explanation of why this query would be effective in retrieving this document.</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="st">  "broad_topical_query": "Your query here",</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="st">  "broad_topical_explanation": "Brief explanation",</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="st">  "specific_detail_query": "Your query here",</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="st">  "specific_detail_explanation": "Brief explanation",</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="st">  "visual_element_query": "Your query here",</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="st">  "visual_element_explanation": "Brief explanation"</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="st">If there are no relevant visual elements, replace the third query with another specific detail query.</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We ask the model for JSON output, we can represent this using a simple Pydantic model.</p>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GeneralRetrievalQuery(BaseModel):</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    broad_topical_query: <span class="bu">str</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    broad_topical_explanation: <span class="bu">str</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    specific_detail_query: <span class="bu">str</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    specific_detail_explanation: <span class="bu">str</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    visual_element_query: <span class="bu">str</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    visual_element_explanation: <span class="bu">str</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could add additional constraints to our Pydantic model for example we could set a minimum and maximum length for the queries and answers. We’ll get back to this at the end of the post but for now we can make a start with this simpler approach.</p>
<p>We’ll now wrap this in a function to generate a response from the model using our Pydantic model.</p>
</section>
</section>
<section id="an-update-retrieval-focused-prompt" class="level2">
<h2 class="anchored" data-anchor-id="an-update-retrieval-focused-prompt">An update retrieval focused prompt</h2>
<div id="cell-63" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_retrieval_prompt(prompt_name: <span class="bu">str</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, GeneralRetrievalQuery]:</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prompt_name <span class="op">!=</span> <span class="st">"general"</span>:</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Only 'general' prompt is available in this version"</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="st">"""You are an AI assistant specialized in document retrieval tasks. Given an image of a document page, your task is to generate retrieval queries that someone might use to find this document in a large corpus.</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="st">Please generate 3 different types of retrieval queries:</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="st">1. A broad topical query: This should cover the main subject of the document.</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="st">2. A specific detail query: This should focus on a particular fact, figure, or point made in the document.</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="st">3. A visual element query: This should reference a chart, graph, image, or other visual component in the document, if present.</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="st">Important guidelines:</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="st">- Ensure the queries are relevant for retrieval tasks, not just describing the page content.</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="st">- Frame the queries as if someone is searching for this document, not asking questions about its content.</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="st">- Make the queries diverse and representative of different search strategies.</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, also provide a brief explanation of why this query would be effective in retrieving this document.</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="st">  "broad_topical_query": "Your query here",</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="st">  "broad_topical_explanation": "Brief explanation",</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="st">  "specific_detail_query": "Your query here",</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="st">  "specific_detail_explanation": "Brief explanation",</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="st">  "visual_element_query": "Your query here",</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a><span class="st">  "visual_element_explanation": "Brief explanation"</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="st">If there are no relevant visual elements, replace the third query with another specific detail query.</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prompt, GeneralRetrievalQuery</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>prompt_name <span class="op">=</span> <span class="st">"general"</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>prompt, pydantic_model <span class="op">=</span> get_retrieval_prompt(prompt_name)</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Prompt for '</span><span class="sc">{</span>prompt_name<span class="sc">}</span><span class="ss">':"</span>)</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prompt)</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Pydantic model for this prompt: </span><span class="sc">{</span>pydantic_model<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Prompt for 'general':
You are an AI assistant specialized in document retrieval tasks. Given an image of a document page, your task is to generate retrieval queries that someone might use to find this document in a large corpus.

Please generate 3 different types of retrieval queries:

1. A broad topical query: This should cover the main subject of the document.
2. A specific detail query: This should focus on a particular fact, figure, or point made in the document.
3. A visual element query: This should reference a chart, graph, image, or other visual component in the document, if present.

Important guidelines:
- Ensure the queries are relevant for retrieval tasks, not just describing the page content.
- Frame the queries as if someone is searching for this document, not asking questions about its content.
- Make the queries diverse and representative of different search strategies.

For each query, also provide a brief explanation of why this query would be effective in retrieving this document.

Format your response as a JSON object with the following structure:

{
  "broad_topical_query": "Your query here",
  "broad_topical_explanation": "Brief explanation",
  "specific_detail_query": "Your query here",
  "specific_detail_explanation": "Brief explanation",
  "visual_element_query": "Your query here",
  "visual_element_explanation": "Brief explanation"
}

If there are no relevant visual elements, replace the third query with another specific detail query.

Here is the document image to analyze:
&lt;image&gt;

Generate the queries based on this image and provide the response in the specified JSON format.

Pydantic model for this prompt: &lt;class '__main__.GeneralRetrievalQuery'&gt;</code></pre>
</div>
</div>
<p>We’ll now also wrap this in a function to generate a response from the model using our Pydantic model. We could probably do a bit more refactoring here but this will do for now.</p>
<div id="cell-65" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_response(prompt, image):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: [</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"type"</span>: <span class="st">"image"</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"image"</span>: image,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"type"</span>: <span class="st">"text"</span>, <span class="st">"text"</span>: prompt},</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> processor.apply_chat_template(</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        messages, tokenize<span class="op">=</span><span class="va">False</span>, add_generation_prompt<span class="op">=</span><span class="va">True</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    image_inputs, video_inputs <span class="op">=</span> process_vision_info(messages)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> processor(</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span>[text],</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>        images<span class="op">=</span>image_inputs,</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>        videos<span class="op">=</span>video_inputs,</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        padding<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        return_tensors<span class="op">=</span><span class="st">"pt"</span>,</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> inputs.to(<span class="st">"cuda"</span>)</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>    generated_ids <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>    generated_ids_trimmed <span class="op">=</span> [</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>        out_ids[<span class="bu">len</span>(in_ids) :]</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> in_ids, out_ids <span class="kw">in</span> <span class="bu">zip</span>(inputs.input_ids, generated_ids)</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    output_text <span class="op">=</span> processor.batch_decode(</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        generated_ids_trimmed,</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>        skip_special_tokens<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>        clean_up_tokenization_spaces<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> output_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now generate a response from the model for an example image from our UFO dataset.</p>
<div id="cell-67" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>generate_response(prompt, ds[<span class="dv">2</span>][<span class="st">"image"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>['{\n  "broad_topical_query": "Document discussing the possibility of a cameraman going on the record in the future",\n  "broad_topical_explanation": "This query focuses on the main topic of the document, which is the discussion about the cameraman\'s potential to go on the record.",\n  "specific_detail_query": "Document mentioning Ray Santilli and his attempts to persuade the cameraman",\n  "specific_detail_explanation": "This query targets a specific detail in the document, which is Ray Santilli\'s efforts to contact the cameraman.",\n  "visual_element_query": "Document containing images of a damaged leg and an alien\'s foot",\n  "visual_element_explanation": "This query refers to the visual elements present in the document, which are images of a damaged leg and an alien\'s foot."\n}']</code></pre>
</div>
</div>
<p>We can see the model is doing a reasonable job of generating queries.</p>
<pre><code>['{\n  "broad_topical_query": "Document discussing the possibility of a cameraman going on the record in the future",\n  "broad_topical_explanation": "This query focuses on the main topic of the document, which is the discussion about the cameraman\'s potential to go on the record.",\n  "specific_detail_query": "Document mentioning Ray Santilli and his attempts to persuade the cameraman",\n  "specific_detail_explanation": "This query targets a specific detail in the document, which is Ray Santilli\'s efforts to contact the cameraman.",\n  "visual_element_query": "Document containing images of a damaged leg and an alien\'s foot",\n  "visual_element_explanation": "This query refers to the visual elements present in the document, which are images of a damaged leg and an alien\'s foot."\n}']</code></pre>
<pre class="tip"><code>One thing I have found in my experiments with generating synthetic data is that adding a request for an "explanation" from the model sometimes seems to help improve the quality of the generated data. I assume this is already noted somewhere in the literature (if not I'll call this `explain then generate`!). This seems to particularly helpful when generating more complex queries. Having the explanation can also give you a sense of how the model "understands" the task. This obviously comes with the donwside that it takes longer to generate the data and more tokens are required but it often seems worth trying. </code></pre>
</section>
<section id="generating-the-full-dataset" class="level2">
<h2 class="anchored" data-anchor-id="generating-the-full-dataset">Generating the full dataset</h2>
<p>As we play with the prompts and refine the queries we will often iterate quite quickly on a few examples. Once we’re reasonably confident in the queries we can generate a larger dataset to see how well our prompts work across a larger set of examples.</p>
<div id="cell-72" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>Dataset({
    features: ['image'],
    num_rows: 212
})</code></pre>
</div>
</div>
<div id="cell-73" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>sample <span class="op">=</span> ds.take(<span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To generate our full dataset we just wrap our previous code in a loop and run it for all the examples in our dataset. We add a very broad exception handler to catch any errors and continue with the next example. This is obviously not production code but it’s good enough to get started with. If we scale to a much bigger dataset we might want to add some more robust error handling.</p>
<div id="cell-75" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>responses <span class="op">=</span> []</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> tqdm(sample):</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        resp <span class="op">=</span> generate_response(prompt, row[<span class="st">"image"</span>])</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        responses.append(resp)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>        responses.append(<span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"627ce7504864425cbbc6f2282dbd5132","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>responses[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>['{\n  "broad_topical_query": "Document about the Sun and its influence on life",\n  "broad_topical_explanation": "This query focuses on the main subject of the document, which is the Sun and its impact on life.",\n  "specific_detail_query": "New York Times article on the Sun",\n  "specific_detail_explanation": "This query targets a specific detail mentioned in the document, which is the New York Times article on the Sun.",\n  "visual_element_query": "Document with a black and white image",\n  "visual_element_explanation": "This query refers to the visual element present in the document, which is a black and white image."\n}']</code></pre>
</div>
</div>
<p>We can see how many errors we have in our dataset.</p>
<div id="cell-78" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>([r <span class="cf">for</span> r <span class="kw">in</span> responses <span class="cf">if</span> r <span class="kw">is</span> <span class="va">None</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>0</code></pre>
</div>
</div>
<p>No bad generations!</p>
<p>We can also look at the first response to see what it looks like.</p>
<div id="cell-81" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>responses[<span class="dv">0</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>'{\n  "broad_topical_query": "Document about the Sun and its influence on life",\n  "broad_topical_explanation": "This query focuses on the main subject of the document, which is the Sun and its impact on life.",\n  "specific_detail_query": "New York Times article on the Sun",\n  "specific_detail_explanation": "This query targets a specific detail mentioned in the document, which is the New York Times article on the Sun.",\n  "visual_element_query": "Document with a black and white image",\n  "visual_element_explanation": "This query refers to the visual element present in the document, which is a black and white image."\n}'</code></pre>
</div>
</div>
<p>Let’s see if we can parse this into a JSON object.</p>
<div id="cell-83" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>json.loads(responses[<span class="dv">0</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>{'broad_topical_query': 'Document about the Sun and its influence on life',
 'broad_topical_explanation': 'This query focuses on the main subject of the document, which is the Sun and its impact on life.',
 'specific_detail_query': 'New York Times article on the Sun',
 'specific_detail_explanation': 'This query targets a specific detail mentioned in the document, which is the New York Times article on the Sun.',
 'visual_element_query': 'Document with a black and white image',
 'visual_element_explanation': 'This query refers to the visual element present in the document, which is a black and white image.'}</code></pre>
</div>
</div>
<p>first example seems to work, now let’s add this to our dataset and see how many we can parse.</p>
<div id="cell-85" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>sample <span class="op">=</span> sample.add_column(<span class="st">"raw_queries"</span>, responses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-86" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>sample</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>Dataset({
    features: ['image', 'raw_queries'],
    num_rows: 100
})</code></pre>
</div>
</div>
<p>To deal with bad generations we’ll create just fill out these column with <code>None</code> values. We can grab all the required keys from the valid first response.</p>
<div id="cell-88" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>keys <span class="op">=</span> <span class="bu">list</span>(json.loads(responses[<span class="dv">0</span>][<span class="dv">0</span>]).keys())</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>keys</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>['broad_topical_query',
 'broad_topical_explanation',
 'specific_detail_query',
 'specific_detail_explanation',
 'visual_element_query',
 'visual_element_explanation']</code></pre>
</div>
</div>
<p>and do something like this to fill out this row</p>
<div id="cell-90" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>{k: <span class="va">None</span> <span class="cf">for</span> k <span class="kw">in</span> keys}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>{'broad_topical_query': None,
 'broad_topical_explanation': None,
 'specific_detail_query': None,
 'specific_detail_explanation': None,
 'visual_element_query': None,
 'visual_element_explanation': None}</code></pre>
</div>
</div>
<p>We create a function to extract the data from the raw queries and parse them into a JSON object.</p>
<div id="cell-92" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_data(row):</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> json.loads(row[<span class="st">"raw_queries"</span>][<span class="dv">0</span>])</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">"parsed_into_json"</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> data</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> {k: <span class="va">None</span> <span class="cf">for</span> k <span class="kw">in</span> keys}</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">"parsed_into_json"</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now use the <code>map</code> method to apply this function to our dataset.</p>
<div id="cell-94" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>parsed_ds <span class="op">=</span> sample.<span class="bu">map</span>(extract_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then see how many we’ve successfully parsed.</p>
<div id="cell-96" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>Counter(parsed_ds[<span class="st">"parsed_into_json"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>Counter({True: 95, False: 5})</code></pre>
</div>
</div>
<p>So in this case 5% of the responses were not parseable. This isn’t too bad and we might be able to live with this.</p>
</section>
<section id="pushing-to-the-hub" class="level2">
<h2 class="anchored" data-anchor-id="pushing-to-the-hub">Pushing to the Hub</h2>
<p>We can now push this dataset to the Hugging Face Hub. This will also allow us to view the dataset in the Dataset Viewer. This can often be a very nice way of quickly checking through examples in a dataset to see how the quality looks.</p>
<p>If you are not authenticated you can use the <code>login</code> function to authenticate with the Hub.</p>
<div id="cell-100" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> huggingface_hub <span class="im">import</span> login</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-101" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>login()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bd4de41610614d4b83669c1cb8064e02","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="cell-102" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>parsed_ds.push_to_hub(<span class="st">"davanstrien/ufo-ColPali"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6fedd93a30f34aebb0207d2f3ca8c52c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c4d1a1f443fe4b17976f7590434312d4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b08b902c59d447798473df4d5e1eeec1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>CommitInfo(commit_url='https://huggingface.co/datasets/davanstrien/ufo-ColPali/commit/c50c8e42cd01d2dde17ef64e66ea1b826c0ca4ec', commit_message='Upload dataset', commit_description='', oid='c50c8e42cd01d2dde17ef64e66ea1b826c0ca4ec', pr_url=None, repo_url=RepoUrl('https://huggingface.co/datasets/davanstrien/ufo-ColPali', endpoint='https://huggingface.co', repo_type='dataset', repo_id='davanstrien/ufo-ColPali'), pr_revision=None, pr_num=None)</code></pre>
</div>
</div>
<p>Here is what the dataset looks like in the Hugging Face Hub. You’ll see there are actually more than a 100 examples since I did a larger generation of data since doing the first batch of a 100. You can be your own judge but my sense it that the queries are looking pretty good already.</p>
<iframe src="https://huggingface.co/datasets/davanstrien/ufo-ColPali/embed/viewer/default/train" frameborder="0" width="100%" height="560px">
</iframe>
</section>
<section id="conclusion-improvements-and-next-steps" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-improvements-and-next-steps">Conclusion, improvements and next steps</h2>
<p>There are a few improvements that we could make to this process.</p>
<section id="structured-generation" class="level3">
<h3 class="anchored" data-anchor-id="structured-generation">Structured Generation</h3>
<p>One of the first things I think would be worth exploring further is using structured generation to improve the quality of the generated queries. This would allow us to properly use the Pydantic models to constrain the outputs. The <code>Outlines</code> library has functionality for doing this with for <a href="https://dottxt-ai.github.io/outlines/reference/models/transformers_vision/">VLMs</a>. Once I am more satisified with the quality of the queries I’ll come back to this.</p>
</section>
<section id="more-diverse-queries" class="level3">
<h3 class="anchored" data-anchor-id="more-diverse-queries">More diverse queries</h3>
<p>I focused on generating a single type of query for each example in the UFO dataset. I think for a dataset of this size it would be worth taking a more diverse set of generations. Below you can see an apendix with a few options for these kinds of queries.</p>
</section>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps">Next Steps</h3>
<p>I am keen to test this approach with a few more domains and also work on the actual fine-tuning of ColPali models.</p>
</section>
</section>
<section id="appendix-more-diverse-queries" class="level2">
<h2 class="anchored" data-anchor-id="appendix-more-diverse-queries">Appendix more diverse queries</h2>
<p>Here are a few more examples of prompts I am experimenting with.</p>
<div id="cell-107" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Optional, Tuple, Union</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pydantic models for each prompt type</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GeneralRetrievalQuery(BaseModel):</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    broad_topical_query: <span class="bu">str</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    broad_topical_explanation: <span class="bu">str</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    specific_detail_query: <span class="bu">str</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    specific_detail_explanation: <span class="bu">str</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    visual_element_query: <span class="bu">str</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    visual_element_explanation: <span class="bu">str</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiDocumentComparisonQuery(BaseModel):</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    comparison_query: <span class="bu">str</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    comparison_explanation: <span class="bu">str</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    corroboration_contradiction_query: <span class="bu">str</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>    corroboration_contradiction_explanation: <span class="bu">str</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DomainSpecificQuery(BaseModel):</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    identified_domain: <span class="bu">str</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>    domain_specific_query: <span class="bu">str</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>    domain_specific_explanation: <span class="bu">str</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>    data_findings_query: <span class="bu">str</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>    data_findings_explanation: <span class="bu">str</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    applications_implications_query: <span class="bu">str</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>    applications_implications_explanation: <span class="bu">str</span></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VisualElementFocusQuery(BaseModel):</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>    similar_visual_element_query: <span class="bu">str</span></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>    similar_visual_element_explanation: <span class="bu">str</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    text_visual_combination_query: <span class="bu">str</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>    text_visual_combination_explanation: <span class="bu">str</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>    visual_content_understanding_query: <span class="bu">str</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>    visual_content_understanding_explanation: <span class="bu">str</span></span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TemporalMetadataQuery(BaseModel):</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>    temporal_query: <span class="bu">str</span></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>    temporal_explanation: <span class="bu">str</span></span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>    topic_metadata_combination_query: <span class="bu">str</span></span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>    topic_metadata_combination_explanation: <span class="bu">str</span></span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>    update_related_document_query: <span class="bu">str</span></span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>    update_related_document_explanation: <span class="bu">str</span></span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DifficultyAmbiguityQuery(BaseModel):</span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>    simple_query: <span class="bu">str</span></span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>    simple_explanation: <span class="bu">str</span></span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>    complex_query: <span class="bu">str</span></span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a>    complex_explanation: <span class="bu">str</span></span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>    ambiguous_query: <span class="bu">str</span></span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>    ambiguous_explanation: <span class="bu">str</span></span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultilingualMultimodalQuery(BaseModel):</span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a>    multilingual_query: <span class="bu">str</span></span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true" tabindex="-1"></a>    multilingual_explanation: <span class="bu">str</span></span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true" tabindex="-1"></a>    multimodal_combination_query: <span class="bu">str</span></span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true" tabindex="-1"></a>    multimodal_combination_explanation: <span class="bu">str</span></span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true" tabindex="-1"></a>    text_visual_understanding_query: <span class="bu">str</span></span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true" tabindex="-1"></a>    text_visual_understanding_explanation: <span class="bu">str</span></span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-68"><a href="#cb76-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-69"><a href="#cb76-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_retrieval_prompt(</span>
<span id="cb76-70"><a href="#cb76-70" aria-hidden="true" tabindex="-1"></a>    prompt_name: <span class="bu">str</span>,</span>
<span id="cb76-71"><a href="#cb76-71" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[</span>
<span id="cb76-72"><a href="#cb76-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">str</span>,</span>
<span id="cb76-73"><a href="#cb76-73" aria-hidden="true" tabindex="-1"></a>    Union[</span>
<span id="cb76-74"><a href="#cb76-74" aria-hidden="true" tabindex="-1"></a>        GeneralRetrievalQuery,</span>
<span id="cb76-75"><a href="#cb76-75" aria-hidden="true" tabindex="-1"></a>        MultiDocumentComparisonQuery,</span>
<span id="cb76-76"><a href="#cb76-76" aria-hidden="true" tabindex="-1"></a>        DomainSpecificQuery,</span>
<span id="cb76-77"><a href="#cb76-77" aria-hidden="true" tabindex="-1"></a>        VisualElementFocusQuery,</span>
<span id="cb76-78"><a href="#cb76-78" aria-hidden="true" tabindex="-1"></a>        TemporalMetadataQuery,</span>
<span id="cb76-79"><a href="#cb76-79" aria-hidden="true" tabindex="-1"></a>        DifficultyAmbiguityQuery,</span>
<span id="cb76-80"><a href="#cb76-80" aria-hidden="true" tabindex="-1"></a>        MultilingualMultimodalQuery,</span>
<span id="cb76-81"><a href="#cb76-81" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb76-82"><a href="#cb76-82" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb76-83"><a href="#cb76-83" aria-hidden="true" tabindex="-1"></a>    prompts <span class="op">=</span> {</span>
<span id="cb76-84"><a href="#cb76-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"general"</span>: (</span>
<span id="cb76-85"><a href="#cb76-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">"""You are an AI assistant specialized in document retrieval tasks. Given an image of a document page, your task is to generate retrieval queries that someone might use to find this document in a large corpus.</span></span>
<span id="cb76-86"><a href="#cb76-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-87"><a href="#cb76-87" aria-hidden="true" tabindex="-1"></a><span class="st">Please generate 3 different types of retrieval queries:</span></span>
<span id="cb76-88"><a href="#cb76-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-89"><a href="#cb76-89" aria-hidden="true" tabindex="-1"></a><span class="st">1. A broad topical query: This should cover the main subject of the document.</span></span>
<span id="cb76-90"><a href="#cb76-90" aria-hidden="true" tabindex="-1"></a><span class="st">2. A specific detail query: This should focus on a particular fact, figure, or point made in the document.</span></span>
<span id="cb76-91"><a href="#cb76-91" aria-hidden="true" tabindex="-1"></a><span class="st">3. A visual element query: This should reference a chart, graph, image, or other visual component in the document, if present.</span></span>
<span id="cb76-92"><a href="#cb76-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-93"><a href="#cb76-93" aria-hidden="true" tabindex="-1"></a><span class="st">Important guidelines:</span></span>
<span id="cb76-94"><a href="#cb76-94" aria-hidden="true" tabindex="-1"></a><span class="st">- Ensure the queries are relevant for retrieval tasks, not just describing the page content.</span></span>
<span id="cb76-95"><a href="#cb76-95" aria-hidden="true" tabindex="-1"></a><span class="st">- Frame the queries as if someone is searching for this document, not asking questions about its content.</span></span>
<span id="cb76-96"><a href="#cb76-96" aria-hidden="true" tabindex="-1"></a><span class="st">- Make the queries diverse and representative of different search strategies.</span></span>
<span id="cb76-97"><a href="#cb76-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-98"><a href="#cb76-98" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, also provide a brief explanation of why this query would be effective in retrieving this document.</span></span>
<span id="cb76-99"><a href="#cb76-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-100"><a href="#cb76-100" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb76-101"><a href="#cb76-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-102"><a href="#cb76-102" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb76-103"><a href="#cb76-103" aria-hidden="true" tabindex="-1"></a><span class="st">  "broad_topical_query": "Your query here",</span></span>
<span id="cb76-104"><a href="#cb76-104" aria-hidden="true" tabindex="-1"></a><span class="st">  "broad_topical_explanation": "Brief explanation",</span></span>
<span id="cb76-105"><a href="#cb76-105" aria-hidden="true" tabindex="-1"></a><span class="st">  "specific_detail_query": "Your query here",</span></span>
<span id="cb76-106"><a href="#cb76-106" aria-hidden="true" tabindex="-1"></a><span class="st">  "specific_detail_explanation": "Brief explanation",</span></span>
<span id="cb76-107"><a href="#cb76-107" aria-hidden="true" tabindex="-1"></a><span class="st">  "visual_element_query": "Your query here",</span></span>
<span id="cb76-108"><a href="#cb76-108" aria-hidden="true" tabindex="-1"></a><span class="st">  "visual_element_explanation": "Brief explanation"</span></span>
<span id="cb76-109"><a href="#cb76-109" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-110"><a href="#cb76-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-111"><a href="#cb76-111" aria-hidden="true" tabindex="-1"></a><span class="st">If there are no relevant visual elements, replace the third query with another specific detail query.</span></span>
<span id="cb76-112"><a href="#cb76-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-113"><a href="#cb76-113" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb76-114"><a href="#cb76-114" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb76-115"><a href="#cb76-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-116"><a href="#cb76-116" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span>,</span>
<span id="cb76-117"><a href="#cb76-117" aria-hidden="true" tabindex="-1"></a>            GeneralRetrievalQuery,</span>
<span id="cb76-118"><a href="#cb76-118" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb76-119"><a href="#cb76-119" aria-hidden="true" tabindex="-1"></a>        <span class="st">"comparison"</span>: (</span>
<span id="cb76-120"><a href="#cb76-120" aria-hidden="true" tabindex="-1"></a>            <span class="st">"""Imagine this document page is part of a larger corpus. Your task is to generate retrieval queries that would require comparing this document with others in the corpus.</span></span>
<span id="cb76-121"><a href="#cb76-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-122"><a href="#cb76-122" aria-hidden="true" tabindex="-1"></a><span class="st">Please generate 2 retrieval queries:</span></span>
<span id="cb76-123"><a href="#cb76-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-124"><a href="#cb76-124" aria-hidden="true" tabindex="-1"></a><span class="st">1. A query comparing this document's topic with a related subject</span></span>
<span id="cb76-125"><a href="#cb76-125" aria-hidden="true" tabindex="-1"></a><span class="st">2. A query seeking documents that contradict or support the main point of this page</span></span>
<span id="cb76-126"><a href="#cb76-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-127"><a href="#cb76-127" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, provide a brief explanation of how it encourages document comparison and why it would be effective for retrieval.</span></span>
<span id="cb76-128"><a href="#cb76-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-129"><a href="#cb76-129" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb76-130"><a href="#cb76-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-131"><a href="#cb76-131" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb76-132"><a href="#cb76-132" aria-hidden="true" tabindex="-1"></a><span class="st">  "comparison_query": "Your query here",</span></span>
<span id="cb76-133"><a href="#cb76-133" aria-hidden="true" tabindex="-1"></a><span class="st">  "comparison_explanation": "Brief explanation",</span></span>
<span id="cb76-134"><a href="#cb76-134" aria-hidden="true" tabindex="-1"></a><span class="st">  "corroboration_contradiction_query": "Your query here",</span></span>
<span id="cb76-135"><a href="#cb76-135" aria-hidden="true" tabindex="-1"></a><span class="st">  "corroboration_contradiction_explanation": "Brief explanation"</span></span>
<span id="cb76-136"><a href="#cb76-136" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-137"><a href="#cb76-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-138"><a href="#cb76-138" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb76-139"><a href="#cb76-139" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb76-140"><a href="#cb76-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-141"><a href="#cb76-141" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span>,</span>
<span id="cb76-142"><a href="#cb76-142" aria-hidden="true" tabindex="-1"></a>            MultiDocumentComparisonQuery,</span>
<span id="cb76-143"><a href="#cb76-143" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb76-144"><a href="#cb76-144" aria-hidden="true" tabindex="-1"></a>        <span class="st">"domain"</span>: (</span>
<span id="cb76-145"><a href="#cb76-145" aria-hidden="true" tabindex="-1"></a>            <span class="st">"""Your task is to create retrieval queries that a professional in the document's domain might use to find this document in a large corpus.</span></span>
<span id="cb76-146"><a href="#cb76-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-147"><a href="#cb76-147" aria-hidden="true" tabindex="-1"></a><span class="st">First, identify the domain of the document (e.g., scientific, financial, legal, medical, technical).</span></span>
<span id="cb76-148"><a href="#cb76-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-149"><a href="#cb76-149" aria-hidden="true" tabindex="-1"></a><span class="st">Then, generate 3 retrieval queries:</span></span>
<span id="cb76-150"><a href="#cb76-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-151"><a href="#cb76-151" aria-hidden="true" tabindex="-1"></a><span class="st">1. A query using domain-specific terminology</span></span>
<span id="cb76-152"><a href="#cb76-152" aria-hidden="true" tabindex="-1"></a><span class="st">2. A query seeking specific data or findings presented in the document</span></span>
<span id="cb76-153"><a href="#cb76-153" aria-hidden="true" tabindex="-1"></a><span class="st">3. A query related to the document's potential applications or implications</span></span>
<span id="cb76-154"><a href="#cb76-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-155"><a href="#cb76-155" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, provide a brief explanation of its relevance to the domain and why it would be effective for retrieval.</span></span>
<span id="cb76-156"><a href="#cb76-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-157"><a href="#cb76-157" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb76-158"><a href="#cb76-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-159"><a href="#cb76-159" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb76-160"><a href="#cb76-160" aria-hidden="true" tabindex="-1"></a><span class="st">  "identified_domain": "Domain name",</span></span>
<span id="cb76-161"><a href="#cb76-161" aria-hidden="true" tabindex="-1"></a><span class="st">  "domain_specific_query": "Your query here",</span></span>
<span id="cb76-162"><a href="#cb76-162" aria-hidden="true" tabindex="-1"></a><span class="st">  "domain_specific_explanation": "Brief explanation",</span></span>
<span id="cb76-163"><a href="#cb76-163" aria-hidden="true" tabindex="-1"></a><span class="st">  "data_findings_query": "Your query here",</span></span>
<span id="cb76-164"><a href="#cb76-164" aria-hidden="true" tabindex="-1"></a><span class="st">  "data_findings_explanation": "Brief explanation",</span></span>
<span id="cb76-165"><a href="#cb76-165" aria-hidden="true" tabindex="-1"></a><span class="st">  "applications_implications_query": "Your query here",</span></span>
<span id="cb76-166"><a href="#cb76-166" aria-hidden="true" tabindex="-1"></a><span class="st">  "applications_implications_explanation": "Brief explanation"</span></span>
<span id="cb76-167"><a href="#cb76-167" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-168"><a href="#cb76-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-169"><a href="#cb76-169" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb76-170"><a href="#cb76-170" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb76-171"><a href="#cb76-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-172"><a href="#cb76-172" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span>,</span>
<span id="cb76-173"><a href="#cb76-173" aria-hidden="true" tabindex="-1"></a>            DomainSpecificQuery,</span>
<span id="cb76-174"><a href="#cb76-174" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb76-175"><a href="#cb76-175" aria-hidden="true" tabindex="-1"></a>        <span class="st">"visual"</span>: (</span>
<span id="cb76-176"><a href="#cb76-176" aria-hidden="true" tabindex="-1"></a>            <span class="st">"""Your task is to generate retrieval queries focusing on the visual elements in this document page (charts, tables, images, diagrams).</span></span>
<span id="cb76-177"><a href="#cb76-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-178"><a href="#cb76-178" aria-hidden="true" tabindex="-1"></a><span class="st">Please generate 3 retrieval queries:</span></span>
<span id="cb76-179"><a href="#cb76-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-180"><a href="#cb76-180" aria-hidden="true" tabindex="-1"></a><span class="st">1. A query specifically asking for documents with similar visual elements</span></span>
<span id="cb76-181"><a href="#cb76-181" aria-hidden="true" tabindex="-1"></a><span class="st">2. A query combining textual and visual information</span></span>
<span id="cb76-182"><a href="#cb76-182" aria-hidden="true" tabindex="-1"></a><span class="st">3. A query that would require understanding the content of the visual element to retrieve this document</span></span>
<span id="cb76-183"><a href="#cb76-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-184"><a href="#cb76-184" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, provide a brief explanation of how it incorporates visual elements and why it would be effective for retrieval.</span></span>
<span id="cb76-185"><a href="#cb76-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-186"><a href="#cb76-186" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb76-187"><a href="#cb76-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-188"><a href="#cb76-188" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb76-189"><a href="#cb76-189" aria-hidden="true" tabindex="-1"></a><span class="st">  "similar_visual_element_query": "Your query here",</span></span>
<span id="cb76-190"><a href="#cb76-190" aria-hidden="true" tabindex="-1"></a><span class="st">  "similar_visual_element_explanation": "Brief explanation",</span></span>
<span id="cb76-191"><a href="#cb76-191" aria-hidden="true" tabindex="-1"></a><span class="st">  "text_visual_combination_query": "Your query here",</span></span>
<span id="cb76-192"><a href="#cb76-192" aria-hidden="true" tabindex="-1"></a><span class="st">  "text_visual_combination_explanation": "Brief explanation",</span></span>
<span id="cb76-193"><a href="#cb76-193" aria-hidden="true" tabindex="-1"></a><span class="st">  "visual_content_understanding_query": "Your query here",</span></span>
<span id="cb76-194"><a href="#cb76-194" aria-hidden="true" tabindex="-1"></a><span class="st">  "visual_content_understanding_explanation": "Brief explanation"</span></span>
<span id="cb76-195"><a href="#cb76-195" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-196"><a href="#cb76-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-197"><a href="#cb76-197" aria-hidden="true" tabindex="-1"></a><span class="st">If the document lacks significant visual elements, explain this and generate alternative queries focusing on the document's structure or layout.</span></span>
<span id="cb76-198"><a href="#cb76-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-199"><a href="#cb76-199" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb76-200"><a href="#cb76-200" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb76-201"><a href="#cb76-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-202"><a href="#cb76-202" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span>,</span>
<span id="cb76-203"><a href="#cb76-203" aria-hidden="true" tabindex="-1"></a>            VisualElementFocusQuery,</span>
<span id="cb76-204"><a href="#cb76-204" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb76-205"><a href="#cb76-205" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temporal"</span>: (</span>
<span id="cb76-206"><a href="#cb76-206" aria-hidden="true" tabindex="-1"></a>            <span class="st">"""Assuming this document is part of a large, diverse corpus, your task is to generate retrieval queries that incorporate metadata or temporal aspects.</span></span>
<span id="cb76-207"><a href="#cb76-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-208"><a href="#cb76-208" aria-hidden="true" tabindex="-1"></a><span class="st">Please generate 3 retrieval queries:</span></span>
<span id="cb76-209"><a href="#cb76-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-210"><a href="#cb76-210" aria-hidden="true" tabindex="-1"></a><span class="st">1. A query specifying a likely time frame for this document</span></span>
<span id="cb76-211"><a href="#cb76-211" aria-hidden="true" tabindex="-1"></a><span class="st">2. A query combining topical information with a metadata element (e.g., author, publication type)</span></span>
<span id="cb76-212"><a href="#cb76-212" aria-hidden="true" tabindex="-1"></a><span class="st">3. A query seeking updated or related documents on the same topic</span></span>
<span id="cb76-213"><a href="#cb76-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-214"><a href="#cb76-214" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, provide a brief explanation of how it uses temporal or metadata information and why it would be effective for retrieval.</span></span>
<span id="cb76-215"><a href="#cb76-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-216"><a href="#cb76-216" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb76-217"><a href="#cb76-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-218"><a href="#cb76-218" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb76-219"><a href="#cb76-219" aria-hidden="true" tabindex="-1"></a><span class="st">  "temporal_query": "Your query here",</span></span>
<span id="cb76-220"><a href="#cb76-220" aria-hidden="true" tabindex="-1"></a><span class="st">  "temporal_explanation": "Brief explanation",</span></span>
<span id="cb76-221"><a href="#cb76-221" aria-hidden="true" tabindex="-1"></a><span class="st">  "topic_metadata_combination_query": "Your query here",</span></span>
<span id="cb76-222"><a href="#cb76-222" aria-hidden="true" tabindex="-1"></a><span class="st">  "topic_metadata_combination_explanation": "Brief explanation",</span></span>
<span id="cb76-223"><a href="#cb76-223" aria-hidden="true" tabindex="-1"></a><span class="st">  "update_related_document_query": "Your query here",</span></span>
<span id="cb76-224"><a href="#cb76-224" aria-hidden="true" tabindex="-1"></a><span class="st">  "update_related_document_explanation": "Brief explanation"</span></span>
<span id="cb76-225"><a href="#cb76-225" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-226"><a href="#cb76-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-227"><a href="#cb76-227" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb76-228"><a href="#cb76-228" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb76-229"><a href="#cb76-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-230"><a href="#cb76-230" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span>,</span>
<span id="cb76-231"><a href="#cb76-231" aria-hidden="true" tabindex="-1"></a>            TemporalMetadataQuery,</span>
<span id="cb76-232"><a href="#cb76-232" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb76-233"><a href="#cb76-233" aria-hidden="true" tabindex="-1"></a>        <span class="st">"difficulty"</span>: (</span>
<span id="cb76-234"><a href="#cb76-234" aria-hidden="true" tabindex="-1"></a>            <span class="st">"""Your task is to create retrieval queries for this document at different levels of complexity and ambiguity.</span></span>
<span id="cb76-235"><a href="#cb76-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-236"><a href="#cb76-236" aria-hidden="true" tabindex="-1"></a><span class="st">Please generate 3 retrieval queries:</span></span>
<span id="cb76-237"><a href="#cb76-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-238"><a href="#cb76-238" aria-hidden="true" tabindex="-1"></a><span class="st">1. A simple, straightforward query</span></span>
<span id="cb76-239"><a href="#cb76-239" aria-hidden="true" tabindex="-1"></a><span class="st">2. A complex query requiring understanding of multiple aspects of the document</span></span>
<span id="cb76-240"><a href="#cb76-240" aria-hidden="true" tabindex="-1"></a><span class="st">3. An ambiguous query that could retrieve this document among others</span></span>
<span id="cb76-241"><a href="#cb76-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-242"><a href="#cb76-242" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, provide a brief explanation of its complexity level or ambiguity and why it would be effective or challenging for retrieval.</span></span>
<span id="cb76-243"><a href="#cb76-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-244"><a href="#cb76-244" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb76-245"><a href="#cb76-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-246"><a href="#cb76-246" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb76-247"><a href="#cb76-247" aria-hidden="true" tabindex="-1"></a><span class="st">  "simple_query": "Your query here",</span></span>
<span id="cb76-248"><a href="#cb76-248" aria-hidden="true" tabindex="-1"></a><span class="st">  "simple_explanation": "Brief explanation",</span></span>
<span id="cb76-249"><a href="#cb76-249" aria-hidden="true" tabindex="-1"></a><span class="st">  "complex_query": "Your query here",</span></span>
<span id="cb76-250"><a href="#cb76-250" aria-hidden="true" tabindex="-1"></a><span class="st">  "complex_explanation": "Brief explanation",</span></span>
<span id="cb76-251"><a href="#cb76-251" aria-hidden="true" tabindex="-1"></a><span class="st">  "ambiguous_query": "Your query here",</span></span>
<span id="cb76-252"><a href="#cb76-252" aria-hidden="true" tabindex="-1"></a><span class="st">  "ambiguous_explanation": "Brief explanation"</span></span>
<span id="cb76-253"><a href="#cb76-253" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-254"><a href="#cb76-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-255"><a href="#cb76-255" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb76-256"><a href="#cb76-256" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb76-257"><a href="#cb76-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-258"><a href="#cb76-258" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span>,</span>
<span id="cb76-259"><a href="#cb76-259" aria-hidden="true" tabindex="-1"></a>            DifficultyAmbiguityQuery,</span>
<span id="cb76-260"><a href="#cb76-260" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb76-261"><a href="#cb76-261" aria-hidden="true" tabindex="-1"></a>        <span class="st">"multilingual"</span>: (</span>
<span id="cb76-262"><a href="#cb76-262" aria-hidden="true" tabindex="-1"></a>            <span class="st">"""Your task is to generate retrieval queries considering potential multilingual and multi-modal aspects of the document.</span></span>
<span id="cb76-263"><a href="#cb76-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-264"><a href="#cb76-264" aria-hidden="true" tabindex="-1"></a><span class="st">Please generate 3 retrieval queries:</span></span>
<span id="cb76-265"><a href="#cb76-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-266"><a href="#cb76-266" aria-hidden="true" tabindex="-1"></a><span class="st">1. A query in a different language (if applicable) that would retrieve this document</span></span>
<span id="cb76-267"><a href="#cb76-267" aria-hidden="true" tabindex="-1"></a><span class="st">2. A query combining textual and non-textual elements</span></span>
<span id="cb76-268"><a href="#cb76-268" aria-hidden="true" tabindex="-1"></a><span class="st">3. A query that requires understanding both the text and visual elements to retrieve this document accurately</span></span>
<span id="cb76-269"><a href="#cb76-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-270"><a href="#cb76-270" aria-hidden="true" tabindex="-1"></a><span class="st">For each query, provide a brief explanation of its multilingual or multi-modal nature and why it would be effective for retrieval.</span></span>
<span id="cb76-271"><a href="#cb76-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-272"><a href="#cb76-272" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as a JSON object with the following structure:</span></span>
<span id="cb76-273"><a href="#cb76-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-274"><a href="#cb76-274" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb76-275"><a href="#cb76-275" aria-hidden="true" tabindex="-1"></a><span class="st">  "multilingual_query": "Your query here",</span></span>
<span id="cb76-276"><a href="#cb76-276" aria-hidden="true" tabindex="-1"></a><span class="st">  "multilingual_explanation": "Brief explanation",</span></span>
<span id="cb76-277"><a href="#cb76-277" aria-hidden="true" tabindex="-1"></a><span class="st">  "multimodal_combination_query": "Your query here",</span></span>
<span id="cb76-278"><a href="#cb76-278" aria-hidden="true" tabindex="-1"></a><span class="st">  "multimodal_combination_explanation": "Brief explanation",</span></span>
<span id="cb76-279"><a href="#cb76-279" aria-hidden="true" tabindex="-1"></a><span class="st">  "text_visual_understanding_query": "Your query here",</span></span>
<span id="cb76-280"><a href="#cb76-280" aria-hidden="true" tabindex="-1"></a><span class="st">  "text_visual_understanding_explanation": "Brief explanation"</span></span>
<span id="cb76-281"><a href="#cb76-281" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb76-282"><a href="#cb76-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-283"><a href="#cb76-283" aria-hidden="true" tabindex="-1"></a><span class="st">If the document is not suitable for multilingual queries, explain why and provide an alternative query.</span></span>
<span id="cb76-284"><a href="#cb76-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-285"><a href="#cb76-285" aria-hidden="true" tabindex="-1"></a><span class="st">Here is the document image to analyze:</span></span>
<span id="cb76-286"><a href="#cb76-286" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;image&gt;</span></span>
<span id="cb76-287"><a href="#cb76-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-288"><a href="#cb76-288" aria-hidden="true" tabindex="-1"></a><span class="st">Generate the queries based on this image and provide the response in the specified JSON format."""</span>,</span>
<span id="cb76-289"><a href="#cb76-289" aria-hidden="true" tabindex="-1"></a>            MultilingualMultimodalQuery,</span>
<span id="cb76-290"><a href="#cb76-290" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb76-291"><a href="#cb76-291" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-292"><a href="#cb76-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-293"><a href="#cb76-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prompt_name <span class="kw">not</span> <span class="kw">in</span> prompts:</span>
<span id="cb76-294"><a href="#cb76-294" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb76-295"><a href="#cb76-295" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Invalid prompt name. Choose from: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(prompts.keys())<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb76-296"><a href="#cb76-296" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb76-297"><a href="#cb76-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-298"><a href="#cb76-298" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prompts[prompt_name]</span>
<span id="cb76-299"><a href="#cb76-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-300"><a href="#cb76-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-301"><a href="#cb76-301" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb76-302"><a href="#cb76-302" aria-hidden="true" tabindex="-1"></a>prompt_name <span class="op">=</span> <span class="st">"general"</span>  <span class="co"># You can change this to any of the available prompt names</span></span>
<span id="cb76-303"><a href="#cb76-303" aria-hidden="true" tabindex="-1"></a>prompt, pydantic_model <span class="op">=</span> get_retrieval_prompt(prompt_name)</span>
<span id="cb76-304"><a href="#cb76-304" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Prompt for '</span><span class="sc">{</span>prompt_name<span class="sc">}</span><span class="ss">':"</span>)</span>
<span id="cb76-305"><a href="#cb76-305" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prompt)</span>
<span id="cb76-306"><a href="#cb76-306" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Pydantic model for this prompt: </span><span class="sc">{</span>pydantic_model<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"28e069db020443f384c73cb245f65b54":{"model_module":"@jupyter-widgets/base","model_module_version":"1.2.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"2ee27dde4e9e40df9df1e75f4c2c6593":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_8e79441ecebd4572a34e61fdc75282c8","placeholder":"​","style":"IPY_MODEL_c59c74c422f54586a598a651711739c1","value":" 5/5 [00:06&lt;00:00,  1.17s/it]"}},"6aeb527891d74d6ab0df02f4ce6f4548":{"model_module":"@jupyter-widgets/base","model_module_version":"1.2.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"788850f17ebd4a6a8f20687ad6bd9c0e":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"DescriptionStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"7a782d19a21c4924a284ee20c673cb2e":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"8e79441ecebd4572a34e61fdc75282c8":{"model_module":"@jupyter-widgets/base","model_module_version":"1.2.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"aead883f733b44e5ac8fa77b71a5e867":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_b7c9b63418314b1db445680dbd045372","placeholder":"​","style":"IPY_MODEL_788850f17ebd4a6a8f20687ad6bd9c0e","value":"Loading checkpoint shards: 100%"}},"b7c9b63418314b1db445680dbd045372":{"model_module":"@jupyter-widgets/base","model_module_version":"1.2.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"ba203de4c19b43babdec20a66c31c659":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_aead883f733b44e5ac8fa77b71a5e867","IPY_MODEL_bc40683096c64618984a9f0f00439003","IPY_MODEL_2ee27dde4e9e40df9df1e75f4c2c6593"],"layout":"IPY_MODEL_6aeb527891d74d6ab0df02f4ce6f4548"}},"bc40683096c64618984a9f0f00439003":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"ProgressView","bar_style":"success","description":"","description_tooltip":null,"layout":"IPY_MODEL_28e069db020443f384c73cb245f65b54","max":5,"min":0,"orientation":"horizontal","style":"IPY_MODEL_7a782d19a21c4924a284ee20c673cb2e","value":5}},"c59c74c422f54586a598a651711739c1":{"model_module":"@jupyter-widgets/controls","model_module_version":"1.5.0","model_name":"DescriptionStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}}}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/danielvanstrien\.xyz");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>